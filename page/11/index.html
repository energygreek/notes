
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://energygreek.github.io/notes/page/11/">
      
      
      
        <link rel="next" href="../../tags/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Welcome - Some Notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#welcome" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Some Notes" class="md-header__button md-logo" aria-label="Some Notes" data-md-component="logo">
      
  <img src="../../assets/bird.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Some Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Welcome
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="gray" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Welcome

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
  
    
  
  Tags

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../archive/2025/" class="md-tabs__link">
          
  
  
    
  
  归档

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Some Notes" class="md-nav__button md-logo" aria-label="Some Notes" data-md-component="logo">
      
  <img src="../../assets/bird.png" alt="logo">

    </a>
    Some Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="../.." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Welcome
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#install-kvm-on-debian-of-aarch64-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Install KVM on Debian of aarch64 architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvm" class="md-nav__link">
    <span class="md-ellipsis">
      LVM 功能介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux 中断请求
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rhce8" class="md-nav__link">
    <span class="md-ellipsis">
      记录一下rhce8上课笔记
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    <span class="md-ellipsis">
      SQL优先级问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k8s" class="md-nav__link">
    <span class="md-ellipsis">
      搭建k8s集群
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dockerfile-entrypointcmd" class="md-nav__link">
    <span class="md-ellipsis">
      Dockerfile 中ENTRYPOINT和CMD的区别
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      在文件系统之上再创一个文件系统
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bash-safety" class="md-nav__link">
    <span class="md-ellipsis">
      bash safety
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-register" class="md-nav__link">
    <span class="md-ellipsis">
      c 中 register 关键字
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tags
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    归档
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2025
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2024/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2024
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2023
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2022
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2021
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2020
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2019
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#install-kvm-on-debian-of-aarch64-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Install KVM on Debian of aarch64 architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lvm" class="md-nav__link">
    <span class="md-ellipsis">
      LVM 功能介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux 中断请求
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rhce8" class="md-nav__link">
    <span class="md-ellipsis">
      记录一下rhce8上课笔记
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql" class="md-nav__link">
    <span class="md-ellipsis">
      SQL优先级问题
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#k8s" class="md-nav__link">
    <span class="md-ellipsis">
      搭建k8s集群
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dockerfile-entrypointcmd" class="md-nav__link">
    <span class="md-ellipsis">
      Dockerfile 中ENTRYPOINT和CMD的区别
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      在文件系统之上再创一个文件系统
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bash-safety" class="md-nav__link">
    <span class="md-ellipsis">
      bash safety
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c-register" class="md-nav__link">
    <span class="md-ellipsis">
      c 中 register 关键字
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="welcome">Welcome<a class="headerlink" href="#welcome" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-30 00:00:00+00:00">2020年10月30日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="install-kvm-on-debian-of-aarch64-architecture"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/">Install KVM on Debian of aarch64 architecture</a></h2>
<p>公司有台arm64位的设备，安装的银河麒麟系统，经验证就是debian 9。<br />
现在需要运行更多arm64虚拟机。</p>
<h2 id="_1"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#_1">安装步骤</a></h2>
<h3 id="sudoer"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#sudoer">配置免密sudoer</a></h3>
<p>这里记一个坑， 第一次配置时拼写错误，导致sudo 命令执行失败。需要重置密码，所以很麻烦。 <br />
然后推荐使用 <code>sudo visudo</code> 命令来修改sudoer配置文件，这个命令在编辑结束后校验配置文件，避免出现编辑错误导致无法使用sudo的情况。  </p>
<div class="highlight"><pre><span></span><code>kylin@Kylin:~$ cat /etc/sudoers.d/kylin 
kylin   ALL=(ALL:ALL) NOPASSWD:ALL
</code></pre></div>
<h3 id="_2"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#_2">配置软件源</a></h3>
<p>第一个是本地iso, 下面的是中科大的镜像源。 每个都设置了trust免校验gpg</p>
<div class="highlight"><pre><span></span><code>deb [trusted=yes] file:///mnt/iso/ juniper main multiverse restricted universe
deb [trusted=yes] http://ftp.cn.debian.org/debian/ stretch main contrib non-free
deb [trusted=yes] http://ftp.cn.debian.org/debian/ stretch-updates main contrib non-free
deb [trusted=yes] http://mirrors.ustc.edu.cn/debian-security/ stretch/updates main contrib non-free
deb [trusted=yes] http://ftp.cn.debian.org/debian/ stretch-backports main contrib non-free 
</code></pre></div>
<h3 id="_3"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#_3">安装虚拟工具</a></h3>
<p>安装 qemu, libvirt, virt-manager</p>
<div class="highlight"><pre><span></span><code>sudo apt install  qemu  libvirt virt-manager
</code></pre></div>
<h3 id="libvirt"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#libvirt">libvirt 没有网络</a></h3>
<p>执行<code>virsh net-list -all</code> 发现default 网络处于未激活状态， 于是执行 <code>systemctl status libvirtd</code> 发现</p>
<p><div class="highlight"><pre><span></span><code>10月 30 15:46:27 Kylin libvirtd[16741]: 2020-10-30 07:46:27.262+0000: 16764: error : virFileReadAll:1420 : 打开文件 &#39;/sys/class/net/virbr0-nic/operstate&#39; 失败: 没有那个文件或目录
10月 30 15:46:27 Kylin libvirtd[16741]: 2020-10-30 07:46:27.262+0000: 16764: error : virNetDevGetLinkInfo:2530 : unable to read: /sys/class/net/virbr0-nic/operstate: 没有那个文件或目录
10月 30 15:46:54 Kylin libvirtd[16741]: 2020-10-30 07:46:54.710+0000: 16745: error : virFirewallApply:916 : 内部错误：Failed to initialize a valid firewall backend
</code></pre></div>
需要安装以下组件，然后重启libvirtd，这是因为libvirt的网络依赖这几个组件来创建nat 网络</p>
<div class="highlight"><pre><span></span><code>sudo apt install ebtables iptables dnsmasq
systemctl restart libvirtd
</code></pre></div>
<h3 id="virt-manager-aarch64-uefi"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#virt-manager-aarch64-uefi">virt-manager 提示aarch64 安装 uefi 错误</a></h3>
<p>直接安装 qemu-efi
<div class="highlight"><pre><span></span><code>apt install qemu-efi
</code></pre></div></p>
<h3 id="virt-manager-root"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#virt-manager-root">virt-manager 允许非root用户访问</a></h3>
<p>因为当以普通用户运行 virt-manager 时，qemu的连接指向非qemu:///system， 这时看到的虚拟机和root看到的不一样，所以必须使用sudo运行。
通过修改配置来启用普通用户也访问<code>qemu:///system</code>， 将uri_defualt 的注释去掉。</p>
<div class="highlight"><pre><span></span><code>vim /etc/libvirt/libvirt.conf 

#
# These can be used in cases when no URI is supplied by the application
# (@uri_default also prevents probing of the hypervisor driver).
#
uri_default = &quot;qemu:///system&quot;
</code></pre></div>
<h2 id="virt-managerx86"><a class="toclink" href="../../2020/10/30/install-kvm-on-debian-of-aarch64-architecture/#virt-managerx86">这样就可以使用virt-manager来创建虚拟机了，跟x86的使用一样。</a></h2>
<p>顺便记一下vnc的配置， 因为机器在机房里， 通过tigervnc来使用桌面。<br />
另外提示一下，virt-manager 配置好后，可以直接连接远程的virt-manager,非常方便。</p>
<p>使用tigervnc 连接需要在远程主机安装 tigervnc-server 和 tigervnc-password。
使用普通用户执行 <code>tigervnc-password</code> 设置访问密码，然后直接执行<code>tigervnc-server</code>。</p>
<p>这时候vnc只接受本地连接， 如果远程访问，要使用ssh 本地转发来实现。 这也是vnc推荐的方式。</p>
<p>现在本地允许本地转发命令， 监听本地端口 9302, 转发到远程的 9300
<div class="highlight"><pre><span></span><code>ssh -L 9302:localhost:9300   -N -f  ssh-kylin
</code></pre></div></p>
<p>然后执行 <code>vncviewer  127.0.0.1:9302</code> ，输入密码就能打开远程桌面了。</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-22 00:00:00+00:00">2020年10月22日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="lvm"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/">LVM 功能介绍</a></h2>
<p>LVM 是在硬件和系统之间多加了一层，可以很方便地修改分区和扩容。 从效率上看肯定有所损失的，但是对于企业而言，灵活性也很重要<br />
LVM具有在线扩容和快照的重要功能</p>
<h3 id="_1"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_1">在线扩容</a></h3>
<p>当磁盘容量不够或者需要替换磁盘时，就需要扩容, 如果是替换磁盘就再需要换出旧硬盘</p>
<h4 id="_2"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_2">扩容步骤</a></h4>
<p>使用lvm中的pvmove 命令假如原来是使用pv 为/dev/sda1, 新的硬盘为/dev/sdb1<br />
1. 新建pv: # pvcreate /dev/sdb1 
2. 扩容vg：# vgextend vg1 /dev/sdb1 
3. 如果要调整分区大小，使用lvresize -r -S 新大小。 不带-r的话需要重新mount才能生效， -S 是表示最终大小，-s +/- 是调整大小</p>
<h4 id="_3"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_3">换出步骤</a></h4>
<p>vgreduce 是将pv踢出vg, pvremove是删除pv标记</p>
<ol>
<li>把sda1 上数据迁移到sdb1上： # pvmove  /dev/sda1  /dev/sdb1 </li>
<li>vgreduce 从vg1踢出sda1盘 # vgreduce vg1 /dev/sda1  </li>
<li>pvremove 删除磁盘分区的pv 标记 # pvremove /dev/sda1 </li>
</ol>
<h4 id="_4"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_4">磁盘换出是否需要停业务</a></h4>
<p>LVM的在线扩容是不需要停止业务的，但是应该在业务闲的时候做。LVM在做pvmove的时候，会冻结旧分区，新的操作就需要做备份。 
pvmove有时候很慢，但是不能中断，否则出现很多遗留的分区。 </p>
<p>与pvmove类似的功能的还有磁盘镜像， 磁盘镜像的好处很明显，即使复制失败了，原数据依然存在。</p>
<p>但两个技术都要求能够“原子化”，所以不得不对业务有所影响，而且影响的是磁盘IO， 无法通过降低业务的NICE值来减弱这种影响</p>
<h3 id="lvm_1"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#lvm_1">LVM 快照功能</a></h3>
<p>当系统是安装在LVM文件系统之上，那么当需要进行高危操作的时候，可以先对分区进行快照备份，避免操作失败又无法恢复。
公司有一台centos7的自用系统， 需要升级到Centos8 以支持 Docker buildx。
虽然因操作到无法运行yum,dnf 时宣布失败，但好在有snapshot备份， 恢复后完好如初，太好用。</p>
<h4 id="_5"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_5">步骤</a></h4>
<ol>
<li>挂载如下</li>
</ol>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>lsblk<span class="w"> </span>
NAME<span class="w">                  </span>MAJ:MIN<span class="w"> </span>RM<span class="w">   </span>SIZE<span class="w"> </span>RO<span class="w"> </span>TYPE<span class="w">  </span>MOUNTPOINT
sda<span class="w">                     </span><span class="m">8</span>:0<span class="w">    </span><span class="m">0</span><span class="w">   </span>477G<span class="w">  </span><span class="m">0</span><span class="w"> </span>disk<span class="w">  </span>
├─sda1<span class="w">                  </span><span class="m">8</span>:1<span class="w">    </span><span class="m">0</span><span class="w">   </span>200M<span class="w">  </span><span class="m">0</span><span class="w"> </span>part<span class="w">  </span>/boot/efi
├─sda2<span class="w">                  </span><span class="m">8</span>:2<span class="w">    </span><span class="m">0</span><span class="w">     </span>1G<span class="w">  </span><span class="m">0</span><span class="w"> </span>part<span class="w">  </span>/boot
└─sda3<span class="w">                  </span><span class="m">8</span>:3<span class="w">    </span><span class="m">0</span><span class="w"> </span><span class="m">475</span>.8G<span class="w">  </span><span class="m">0</span><span class="w"> </span>part<span class="w">  </span>
<span class="w">  </span>├─centos-root<span class="w">       </span><span class="m">253</span>:2<span class="w">    </span><span class="m">0</span><span class="w">    </span>50G<span class="w">  </span><span class="m">0</span><span class="w"> </span>lvm<span class="w">   </span>/
<span class="w">  </span>├─centos-swap<span class="w">       </span><span class="m">253</span>:4<span class="w">    </span><span class="m">0</span><span class="w">  </span><span class="m">15</span>.7G<span class="w">  </span><span class="m">0</span><span class="w"> </span>lvm<span class="w">   </span><span class="o">[</span>SWAP<span class="o">]</span>
<span class="w">  </span>├─centos-docker<span class="w">     </span><span class="m">253</span>:18<span class="w">   </span><span class="m">0</span><span class="w">   </span>150G<span class="w">  </span><span class="m">0</span><span class="w"> </span>lvm<span class="w">   </span>/var/lib/docker
</code></pre></div>
<p>根分区为50G, 而卷组还剩余160G,完全足够生成一个镜像，50G并未完全使用。
<div class="highlight"><pre><span></span><code>$ sudo vgs
  VG     #PV #LV #SN Attr   VSize   VFree   
  centos   1   4   0 wz--n- 475.74g  160.05g
  data     1  13   0 wz--n-  &lt;7.28t &lt;721.91g
</code></pre></div></p>
<ol>
<li>
<p>先对根分区进行快照，注意是<code>根分区</code>
<div class="highlight"><pre><span></span><code># lvcreate -s -n &lt;snapshot_name&gt; -L &lt;size&gt; &lt;logical_volume&gt;

$ lvcreate -s -n backup -L 50G  /dev/centos/root
</code></pre></div>
这里指定了快照的大小为50G, 理论上是要比源分区大， 这里也可以直接设置100G, 系统会自动调整大小到合适。</p>
</li>
<li>
<p>进行一顿操作后， 进行恢复, 提示根分区正在使用， 重启后生效。</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>$ lvconvert --mergesnapshot /dev/centos/backup 
  Delaying merge since origin is open.
  Merging of snapshot centos/backup will occur on next activation of centos/root.
</code></pre></div>
<h4 id="_6"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_6">保存</a></h4>
<p>如果需要对快照进行备份到其他位置， 可以直接将快照分区挂载，然后通过tarball 来压缩。</p>
<div class="highlight"><pre><span></span><code>tar -cvzf backup.tar.gz /mnt/lv_snapshot
</code></pre></div>
<p>还可以直接通过rsync 将挂载的snapshort 传输到其他服务器上</p>
<div class="highlight"><pre><span></span><code>rsync -aPh /mnt/lv_snapshot  &lt;remote_user&gt;@&lt;destination_server&gt;:&lt;remote_destination&gt;
</code></pre></div>
<h4 id="_7"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_7">快照回滚</a></h4>
<p>lvm的snapshort 也是写时复制的（copy on write），所以创建快照操作非常快， 
当分区进行删除和修改操作的时候， lvm文件系统会拷贝文件到其他地方保存。</p>
<h4 id="_8"><a class="toclink" href="../../2020/10/22/lvm-%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D/#_8">问题</a></h4>
<p>lvm快照不等于备份， 仅有快照是不能恢复的</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-10-19 00:00:00+00:00">2020年10月19日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linux"><a class="toclink" href="../../2020/10/19/linux-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82/">Linux 中断请求</a></h2>
<p>中断请求的英文是IRQ（Interrupt Request）,是用来驱动CPU正常工作的重要机制。 中断根据源头分类成：
由外设发出的硬件中断，软件发出的软中断，以及异常组成。</p>
<p>以前，每个外设都连接一根线到PIC(programmable Interrupt circuit)芯片，有PIC芯片来发生数据到CPU,并将CPU的INTR引脚置位。
现在，CPU集成了PIC成为APIC(Advanced PIC)。</p>
<h3 id="_1"><a class="toclink" href="../../2020/10/19/linux-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82/#_1">中断分类</a></h3>
<p>中断分为3类型</p>
<h4 id="_2"><a class="toclink" href="../../2020/10/19/linux-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82/#_2">硬件中断</a></h4>
<p>鼠标和键盘，还有IO设备都会发出硬件中断，例如网卡的数据到了，就会出发中断请求（IRQ），
这个请求会触发CPU去执行ISR, 而这个ISR需要在系统启动的时候注册的。一个Vector表。</p>
<h3 id="_3"><a class="toclink" href="../../2020/10/19/linux-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82/#_3">软件中断</a></h3>
<p>当播放电影的时候，声音和画面的同步非常重要，这是由系统的定时器<a href="https://elinux.org/Kernel_Timer_Systems">jiffies</a>来不停地调度声音播放器来准确播放对应的声音。
软中断在实时操作系统的作用也非常重要。</p>
<h4 id="_4"><a class="toclink" href="../../2020/10/19/linux-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82/#_4">异常中断</a></h4>
<p>异常中断又分为3类： 缺页异常(Faults)，陷入异常(Traps)，异常退出(Aborts)</p>
<p>例如当程序的内存被swap到硬盘了或者一段动态链接库还没有载入到内存里来，在程序走到这个位置之前，
程序就会提前发出缺页异常，当系统检查了权限和地址有效后（地址有效表示在逻辑地址范围内），
CPU开始为程序执行加载需要的数据，并清除这个异常。 所以这个异常是可以修正的，这个请求必须提前发出。</p>
<p>当GDB调试的时，设置断点会插入一条特殊的指令到程序里，当执行到断点位置就会出发Traps请求，软件的主导权由CPU交给GDB。</p>
<p>当程序触发一个异常例如0/0时，会出发退出异常，由cpu来清理堆栈。</p>
<h3 id="_5"><a class="toclink" href="../../2020/10/19/linux-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82/#_5">请求的可阻塞性</a></h3>
<p>对于硬件中断请求，CPU的决策是立即执行，对于软中断和异常，CPU采用尽量延后的策略。</p>
<h3 id="_6"><a class="toclink" href="../../2020/10/19/linux-%E4%B8%AD%E6%96%AD%E8%AF%B7%E6%B1%82/#_6">查看系统的中断</a></h3>
<p>在中断执行 <code>watch -n1 "cat /proc/interrupts"</code>可以定时更新中断的次数</p>
<p>列的含义从左至右以此为：
<div class="highlight"><pre><span></span><code> IRQ vector, interrupt count per CPU (0 .. n), the hardware source, the hardware source&#39;s channel information, and the name of the device that caused the IRQ.
</code></pre></div></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-29 00:00:00+00:00">2020年8月29日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 5 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="rhce8"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/">记录一下rhce8上课笔记</a></h2>
<ol>
<li>进入nfs，autofs目录卡住，如何退出，应该是进入了D状态 </li>
<li>chrome 需要笔记本插件，js控制插件</li>
<li>修改root密码时，在linux 选项后面添加 rd.break 然后默认进入内核根目录，然后rw重新挂载系统根目录 /sysroot/ </li>
<li>fdisk 设置分区类型: 在创建分区结束后，使用<code>t</code>来标记文件类型, 然后使用<code>L</code>查看类型代码，查找到Linux swap 对应的代码是85</li>
</ol>
<h3 id="rhcia"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#rhcia">RHCIA</a></h3>
<h4 id="nmcli-connection-downup-connection"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#nmcli-connection-downup-connection">修改了网络信息之后，必须使用nmcli connection down和up connection才会生效</a></h4>
<div class="highlight"><pre><span></span><code>nmtui connection down Wired_connection1
nmtui connection up Wired_connection1
</code></pre></div>
<h4 id="httpdportportsemanagetagjourneyctl-e"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#httpdportportsemanagetagjourneyctl-e">配置httpd服务时，修改port后，因为port非标准端口，需要用semanage打tag。否则失败，可以查看journeyctl -e 查看到错误信息和解决办法</a></h4>
<div class="highlight"><pre><span></span><code>semanage port -a -t http_port_t -p tcp 82
</code></pre></div>
<h4 id="homeadmins-adminusr-s-"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#homeadmins-adminusr-s-">创建/home/admins 目录，并设置在目录中创建的文件，其组所有权自动设置为 adminusr。 这里就是设置s位，有数值方法和+-法</a></h4>
<div class="highlight"><pre><span></span><code>chmod 2770 /home/admins

# 或

chmod o-x /home/admins
chmod o-r /home/admins
chmod g+w /home/admins
chmod g+s /home/admins # 这里设置组的s位
</code></pre></div>
<p>验证方法，进入目录创建文件，查看组名</p>
<h4 id="autofs-etcautomasterd-autofs"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#autofs-etcautomasterd-autofs">autofs 挂载有两个关键，第一在/etc/auto.master.d/ 目录下创建后缀名为autofs的文件， 第二是编辑挂载配置文件</a></h4>
<p>内容格式
<div class="highlight"><pre><span></span><code># cat /etc/auto.master.d/indirect
#主挂载点   挂载配置
/internal   /etc/auto.demo
</code></pre></div></p>
<p>内容配置，* 表示所有目录（根据nfsserver的情况）， 和&amp;搭配使用
<div class="highlight"><pre><span></span><code># cat /etc/auto.demo
# 间接挂载目录    挂载配置    挂载路径（nfs地址）
*   -rw,fstype=nfs4,sync    servera:/shares/indirect/&amp;
</code></pre></div></p>
<h4 id="setfacl-getfacl"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#setfacl-getfacl">setfacl 和getfacl 设置和显示文件属性</a></h4>
<div class="highlight"><pre><span></span><code>设置natash用户读写权限
setfacl u:natasha:rw    /var/tmp/fstab
设置harry用户没有任何权限 
setfacl u:harry:-   /var/tmp/fstab
</code></pre></div>
<h4 id="rootlinux-rdlocal-ctrlx"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#rootlinux-rdlocal-ctrlx">重置root密码，在linux 行末追加 rd.local, 按ctrl+x 启动</a></h4>
<p>重新挂载系统根目录, chroot到根目录和修改密码
<div class="highlight"><pre><span></span><code>mount -orw,remount /systemroot/
chroot /systemroot/
passwd
</code></pre></div></p>
<h4 id="_1"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#_1">逻辑卷扩容</a></h4>
<p>设置分区start位置的时候，输入2048s。 s指扇区，一个扇区为512字节， 2048s指1M，这1M的分区为esp分区</p>
<p>扩容命令lvextrend，这个扩容只是将逻辑卷扩容， 而题目要求对文件系统扩容， 还需要执行文件系统类型对应的扩容命令如resize2fs(ext), xfs_growfs(xfs)。 
但对lvextend命令添加 -r 参数可以一步到位
<div class="highlight"><pre><span></span><code># 扩容到300MB
lvextend -r -L 300MB /dev/new_redhat/lv1
</code></pre></div></p>
<h4 id="-s"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#-s">创建逻辑分区, 注意避免磁盘不够用，尽量共用上一题的磁盘。而且创建卷组的时候不要忘记-s参数</a></h4>
<p>题目可能不是直接给分区大小，而是给出扩展块大小和拓展块个数，其实分区大小=拓展块大小 × 拓展块个数。 在lvcreate -l 来指定块个数 </p>
<p>这时必须使用msdos分区类型才有主分区和拓展分区，而且为拓展分区分配剩余的所有空间。 最后在拓展分区上创建逻辑分区， 并将创建的逻辑分区加入卷组</p>
<p>创建分区，大小通过上面的算法计算出来
<div class="highlight"><pre><span></span><code>parted 
mkpart
print
exit
</code></pre></div></p>
<p>创建卷组
<div class="highlight"><pre><span></span><code>vgcreate -s 20MB -n npgroup /dev/vdb2
</code></pre></div>
创建逻辑卷, 注意是小写l
<div class="highlight"><pre><span></span><code>lvcreate -l 45 -n np npgroup
</code></pre></div>
这样就创建了一个 20×45 = 900MB的逻辑卷</p>
<h4 id="swapfstab"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#swapfstab">创建新的swap分区，注意需要修改fstab, 而且验证的时候，不需要重启系统，而是执行</a></h4>
<div class="highlight"><pre><span></span><code>systemctl daemon-reload 
swapon -a  # 类似mount -a
swapon --show 
</code></pre></div>
<h4 id="vdo-vdologicalsize-5g-gb"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#vdo-vdologicalsize-5g-gb">vdo  --vdoLogicalSize 5G, 不能使用GB</a></h4>
<p><div class="highlight"><pre><span></span><code>vdo create --name test --vdoLogicalSize 5G --device /dev/vdb
</code></pre></div>
<code>blkid</code> 查到 UUID, 最后添加到fstab</p>
<h4 id="vdo-mount"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#vdo-mount">vdo 持久挂载 mount</a></h4>
<div class="highlight"><pre><span></span><code>default,x-systemd.requires=vdo.service
</code></pre></div>
<h3 id="rhce"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#rhce">RHCE</a></h3>
<p>ansible的有用命令
ansbile-doc -l | grep  查找模块和介绍
ansible-doc 模块 查看模块具体说明</p>
<h4 id="inventory"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#inventory">创建inventory 文件， 子组的写法为</a></h4>
<p>[webservices:children]
prod</p>
<p>prod 是webserverices组的子组</p>
<h4 id="ansiblecfg-etcansbileansiblecfg-ansbile"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#ansiblecfg-etcansbileansiblecfg-ansbile">创建ansible.cfg 文件，可以复制 /etc/ansbile/ansible.cfg 到～/ansbile/目录下</a></h4>
<p>容易忘记的选项是远程登陆身份， 即配置 remote_user = devops
如果环境没有配置免密登陆，需要在[defaults] 栏添加 <code>ask_pass = True</code></p>
<p>验证方法 <code>ansible all -m ping</code></p>
<h4 id="ansbile-ad-hoc-yum-ansible-ansible-m-a"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#ansbile-ad-hoc-yum-ansible-ansible-m-a">ansbile ad-hoc 添加yum 源  ansible 模块的使用方法 ansible 主机名 -m 模块 -a '参数'</a></h4>
<p>脚本要添加可执行权限</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="c1"># 先要切换到工作目录</span>
<span class="nb">cd</span><span class="w"> </span>/home/devops/ansible/

ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>yum-repository<span class="w">  </span>-a<span class="w"> </span><span class="s1">&#39;name=  description=  baseurl=  enabled= gpgcheck= gpgkey= &#39;</span>
</code></pre></div>
<h4 id="_2"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#_2">安装软件包</a></h4>
<p>安装软件包如'Development Tools', 需要在包名前面加'@'即 '@Development Tools'
验证yaml 语法格式: <code>ansible-playbook --syntax-check *.yml</code></p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install  development tools</span>
<span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install development tools</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">yum</span><span class="p p-Indicator">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;@Development</span><span class="nv"> </span><span class="s">Tools&quot;</span>
<span class="w">          </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w">                  </span>
</code></pre></div>
<h4 id="rhel-system-roles-roles"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#rhel-system-roles-roles">同步时间依赖角色，安装角色包'rhel-system-roles' 需要在配置文件里添加上roles路径</a></h4>
<p>playbook 示例在/usr/share/ansibe/roles/rhel-system-roles.timesync/Readme.md
现成的yml示例在/usr/share/doc/rhel-system-roles/timesync/example-timesync-playbook.yml</p>
<div class="highlight"><pre><span></span><code># ansible.cfg
[default]
roles_path = /home/devops/ansible/roles:/usr/share/ansible/roles
</code></pre></div>
<h4 id="ansible-galaxy-roles"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#ansible-galaxy-roles">使用ansible-galaxy 命令安装角色，安装到本地roles目录</a></h4>
<p>yml文件很简单, 执行命令 ansible-galaxy install -r roles/requirement.yml -p roles/
-p 表示安装路径 </p>
<div class="highlight"><pre><span></span><code>- name: balancer
  file: /home/devops/ansible/files/5/haproxy.tar
</code></pre></div>
<h4 id="apache"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#apache">创建apache角色， 角色对应一系列的任务和模板文件</a></h4>
<p>通过<code>ansible-galaxy init apache</code> 来初始化角色目录，修改角色目录下的tasks/mail.yml 来添加任务，任务所需的模板文件在同级目录templates下<br />
通过<code>ansible servera -m setup</code> 来查询环境变量， 在模板文件中使用<code>ansible_facts['fqdn']</code> 来引用变量
题目说的hostname 是<code>serverc.lab.example.com</code> 对应变量是fqdn, 另外一个是ip即 ['default_ipv4']['address']</p>
<p>例如，安装httpd用到yum模块， 启用httpd 用到service模块， 防火墙配置用到firewalld模块
<div class="highlight"><pre><span></span><code># home/devops/ansible/role/apache/tasks/main.yml

---
- name: install httpd
  yum:
    name: httpd
    state: present

- name: enable httpd
  service:
    name: httpd
    state: started
    enabled: yes

- name: firewalld config
  firewalld:
    service: httpd
    immediate: yes
    permanent: yes
    state: enabled

- name: install templates
  template:
    src: index.html.j2
    dest: /var/www/html/index.html 
</code></pre></div></p>
<p>模块文件放到templates目录下
<div class="highlight"><pre><span></span><code># home/devops/ansible/role/apache/templates/index.html.j2
Welcome to {{ ansible_facts[&#39;fqdn&#39;] }} on {{ ansible_facts[&#39;default_ipv4&#39;][&#39;address&#39;] }}
</code></pre></div></p>
<p>最后还需要创建一个playbook, 如同其他playbook 一样执行
<div class="highlight"><pre><span></span><code># newrole.yml
---
- name: install new role
  hosts: webservers
  roles:
    - apache
</code></pre></div></p>
<h4 id="balancer"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#balancer">执行balancer 角色, 创建一个负载均衡</a></h4>
<p>验证：
ssh到serverd 上，curl localhost, 先是访问的serverb, 然后访问的serverc</p>
<div class="highlight"><pre><span></span><code>---
- name: deploy apache on webservers
  hosts: webservers
  roles:
    - apache

- name: deploy balancer on balancer
  hosts: balancers
  roles:
    - balancer

- name: deploy phpinfo on webservers
  hosts: webservers
  roles:
    - phpinfo
</code></pre></div>
<h5 id="bindbalance-roletemplate"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#bindbalance-roletemplate">可能出现的错误，提示应该使用bind，这是由于balance role的template 错误</a></h5>
<p>修改办法, 将listen行换行并加上bind</p>
<div class="highlight"><pre><span></span><code># /home/devops/ansible/roles/balancer/templates/haproxy.cfg.j2

backend app
<span class="w"> </span> {% for host in groups.balancers %}
<span class="gd">-   listen {{ daemonname }} 0.0.0.0:{{ listenport }}</span>
<span class="gi">+   listen {{ daemonname }} </span>
<span class="gi">+   bind 0.0.0.0:{{ listenport }}</span>
<span class="w"> </span> {% endfor %}
</code></pre></div>
<h4 id="blockrescuealways-lvolwhen-play"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#blockrescuealways-lvolwhen-play">创建逻辑卷，考验block/rescue/always, 使用lvol，<code>when</code> 和play对齐</a></h4>
<p>使用了block/rescue/always就不需要tasks关键词</p>
<div class="highlight"><pre><span></span><code>---
- name: create a logic volume with size of 5000 and format
  hosts: all
  block:
    - name: create logic volume
      lvol:
        vg: research
        lv: data
        size: 1500
    - name: fomat data volume
        filesystem:
          fstype: ext4
          dev: /dev/research/data
  rescue:
    - name: debug message
      debug:
        msg: can&#39;t create a size of 1800
    - name: create a logical volume with size of 800 and format
        lvol:
          vg: research
          lv: data
          size: 1500
    - name: fomat data volume
        filesystem:
          fstype: ext4
          dev: /dev/research/data
      when: ansible_facts[&#39;lvm&#39;][&#39;vgs&#39;][&#39;research&#39;] is defined
      ignore_errors: yes
    - name: debug 2 
        debug:
          msg: volume group does not exist
      when: ansible_facts[&#39;lvm&#39;][&#39;vgs&#39;][&#39;research&#39;] is undefined
</code></pre></div>
<h4 id="hosts-jinija-forinventory"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#hosts-jinija-forinventory">创建hosts文件， 考验jinija 的for循环和读inventory文件</a></h4>
<p>取facts变量的方法参考balancer的模板： 
/home/ansible/roles/balancer/roles/template/haproxy.cfg.j2</p>
<p>基于给的hosts.j2 文件修改, 拼凑出<code>ip url alias</code>格式，分别对应 default_ipv4.address, fqdn, hostname<br />
ansible_facts在hostvars[host]中</p>
<div class="highlight"><pre><span></span><code># 取
{% for host in groups.all %}
{{ hostvars[host][&#39;ansible_facts&#39;] *忽露不写了* }} × × 
{% endfor %}
--- 

创建playbook的要小心，题目要求生成所有主机的纪录，所以hosts是all, 但只部署在dev组的主机上要加when,   
要加`when: &#39;dev&#39; in group_names`

```yml
---
- name: gen hosts and deploy on dev group
  tasks:
    - name: gen hosts and deploy
        template:
          src: hosts.j2
          dest: /etc/myhosts
      when: &quot;&#39;dev&#39; in group_names&quot;
</code></pre></div>
<h4 id="web-server-setypehttpd_system_content_t"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#web-server-setypehttpd_system_content_t">创建web server, 注意将文件标注setype为httpd_system_content_t</a></h4>
<p>通过man semanager-fcontext 查询setype, 或者使用<code>ls -ldZ</code>来查询selinux标签</p>
<p>创建文件，目录、链接都用file模块，但操作文件内容用copy模块
创建组用group模块,创建用户用user模块
容易搞反的链接的src是指向的文件，所以是/webdev, 可以看帮助文档</p>
<div class="highlight"><pre><span></span><code><span class="gs">---</span>
<span class="gd">- name: create web server</span>
<span class="w"> </span> hosts: webservers
<span class="w"> </span> tasks:
<span class="w"> </span>   - name: add group
<span class="w"> </span>       group:
<span class="w"> </span>          name: webdev
<span class="w"> </span>          state: present
<span class="w"> </span>   - name: create directory
<span class="w"> </span>       file:
<span class="w"> </span>         path: /webdev
<span class="w"> </span>         group: webdev
<span class="w"> </span>         state: directory
<span class="w"> </span>         mode: u+rwx,g+rwxs,o-rx
<span class="w"> </span>-        setype: httpd_system_content_t
<span class="w"> </span>   - name: create a symbolic link
<span class="w"> </span>       file:
<span class="w"> </span>-        src: /var/www/html/webdev
<span class="w"> </span>-        dest: /webdev
<span class="w"> </span>+        src: /webdev
<span class="w"> </span>+        dest: /var/www/html/webdev
<span class="w"> </span>         state: link
<span class="w"> </span>   - name: create index.html
<span class="w"> </span>       copy:
<span class="w"> </span>         content: Development
<span class="w"> </span>         dest: /var/www/html/webdev/index.html
<span class="gi">+         setype: httpd_system_content_t                    </span>
</code></pre></div>
<h4 id="loopsitem-regexslineinfile"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#loopsitem-regexslineinfile">创建硬件报告，用到loops进行数组循环，内置变量item和 regexs匹配，lineinfile 进行文件编辑</a></h4>
<div class="highlight"><pre><span></span><code>---
- name: generate hw report
  hosts: all
  vars:
    hw_all:
      - hw_name: HOST
        hw_content: &quot;{{ ansible_facts[&#39;hostname&#39;] }}&quot;
      - hw_name: BIOS_version
        hw_content: &quot;{{ ansible_facts[&#39;bios_version&#39;] }}&quot;
</code></pre></div>
<h4 id="ansible-vault"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#ansible-vault">创建加密文件，用到ansible-vault命令</a></h4>
<div class="highlight"><pre><span></span><code>ansible-vault encrypt lock.yml --vault-password-file=secret.txt 
</code></pre></div>
<h4 id="ansible-playbook-vault-password-filesecrettxt"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#ansible-playbook-vault-password-filesecrettxt">添加用户， ansible-playbook 通过 --vault-password-file=secret.txt 来传密码文件</a></h4>
<p>通过<code>vars_files</code>来读取变量文件， loop 来循环遍历数组变量， 然后模板直接取密码后用'| password_hash('sha512')' 来加密密码
通常情况下在playbook中，开头位置引用一个变量时都需要"{{ variable }}"， 但是在when块里，则直接使用 variable。 另外字符串要用“string”  </p>
<p>创建用户时， 指定附属组用groups, 主要组是group</p>
<div class="highlight"><pre><span></span><code>- {{ variable }} ## 错误
key: {{ variable }} ## 错误
- &quot;{{ variable}}&quot; ## 正确
key: &quot;{{ variable }}&quot; ## 正确
</code></pre></div>
<p>结果
<div class="highlight"><pre><span></span><code><span class="gs">---</span>
<span class="gd">- name: create user on dev,test</span>
<span class="w"> </span> hosts: dev,test
<span class="w"> </span> vars_files:
<span class="w"> </span>   - lock.yml
<span class="w"> </span>   - user_list.yml
<span class="w"> </span> tasks:
<span class="w"> </span>   - name: create group devops
<span class="w"> </span>     group:
<span class="w"> </span>       name: devops
<span class="w"> </span>       state: present
<span class="w"> </span>   - name: create user 
<span class="w"> </span>     user:
<span class="w"> </span>       name: &quot;{{ item.name }}&quot;
<span class="gd">-       group: devops</span>
<span class="gi">+       groups: devops        </span>
<span class="w"> </span>       password: &quot;{{ pw_developer | password_hash(&#39;sha512&#39;) }}&quot;
<span class="w"> </span>     loop: &quot;{{ user }}&quot;
<span class="gd">-     when: &quot;{{ item.job }}&quot; == developer</span>
<span class="gi">+     when: item.job == &quot;developer&quot;</span>
<span class="gd">- name: create user on prod</span>
<span class="w"> </span> hosts: prod
<span class="w"> </span> vars_files:
<span class="w"> </span>   - lock.yml
<span class="w"> </span>   - users_list.yml
<span class="w"> </span> tasks:
<span class="w"> </span>   - name: create group manager
<span class="w"> </span>     group:
<span class="w"> </span>       name: manager
<span class="w"> </span>       state: present
<span class="w"> </span>   - name: create user
<span class="w"> </span>     user:
<span class="w"> </span>       name: &quot;{{ item.name }}&quot;
<span class="w"> </span>       groups: manager
<span class="w"> </span>       password: &quot;{{ pw_manager | password_hash(&#39;sha512&#39;) }}&quot;
<span class="w"> </span>     loop: &quot;{{ user }}&quot;
<span class="gd">-     when: &quot;{{ item.job }}&quot; == manager</span>
<span class="gi">+     when: item.job == &quot;manager&quot;</span>
</code></pre></div></p>
<h4 id="ansible-vault-rekey"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#ansible-vault-rekey">修改密码, 使用<code>ansible-vault rekey</code> 修改密码，或者先解密后加密</a></h4>
<h4 id="copywhen"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#copywhen">修改文件内容, 使用copy模块，以及when条件判断</a></h4>
<p>在playbook的内建变量 inventory_hostname 表示定义在inventory里的主机名称<br />
也可以使用ansible_facts['hostname'],前提是被管理节点的hostname必须如果管理节点定义名称一样。 因为后者是到被管理节点获取。</p>
<p>使用when 限定条件， 满足条件才能执行这个task
<div class="highlight"><pre><span></span><code>---
- name: create issue
  hosts: all
  tasks:
    - name: create issue file
      copy:
        content: &quot;Development&quot;
        dest: /etc/issue
      when: inventory_name in groups.dev  
</code></pre></div></p>
<h4 id="_3"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#_3">第二次排错</a></h4>
<h5 id="ansible-galaxy-srcname"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#ansible-galaxy-srcname">ansible-galaxy 安装角色, 指定方法分别是 src/name</a></h5>
<div class="highlight"><pre><span></span><code>- src: files/5/balancer.tar
  name: balancer
- src: files/5/phpinfo.tar
  name: phpinfo
</code></pre></div>
<h4 id="timesync-doc-timedatectl-system-clock-syncronize-yes"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#timesync-doc-timedatectl-system-clock-syncronize-yes">timesync 看doc 示例， 验证方法是看timedatectl 看system clock syncronize 为 yes</a></h4>
<div class="highlight"><pre><span></span><code>---
- name: use timesync role
  hosts: all
  vars:
    timesync_ntp_servers:
      - hostname: 
        iburst: yes
  roles:
    - rhel_system_roles.timesync
</code></pre></div>
<h4 id="hosts-for-host-in-groupsall-hostvarshostansible_facts-endfor"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#hosts-for-host-in-groupsall-hostvarshostansible_facts-endfor">创建hosts, 要用 {% for  host in groups.all %} {{ hostvars[host].ansible_facts }} {% endfor %}</a></h4>
<h4 id="firewalldimmediate"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#firewalldimmediate">使用firewalld模块时，需要指定immediate 参数，确保能立即生效</a></h4>
<h4 id="urwxgrwxsorw-urwx"><a class="toclink" href="../../2020/08/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8Brhce8%E4%B8%8A%E8%AF%BE%E7%AC%94%E8%AE%B0/#urwxgrwxsorw-urwx">设置文件的权限时，应使用u=rwx,g=rwxs,o=rw, 而不是u+rwx，原因很好理解</a></h4>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-28 00:00:00+00:00">2020年8月28日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sql"><a class="toclink" href="../../2020/08/28/sql%E4%BC%98%E5%85%88%E7%BA%A7%E9%97%AE%E9%A2%98/">SQL优先级问题</a></h2>
<p>例如数学中的加减乘除，以及编程里的运算符，在sql里也有优先级，依次是：</p>
<div class="highlight"><pre><span></span><code>FROM clause
WHERE clause
SELECT clause
GROUP BY clause
HAVING clause
ORDER BY clause
</code></pre></div>
<p>优先级依次下降，所以FROM的优先级比WHREE高，这样会有什么影响？ </p>
<h3 id="_1"><a class="toclink" href="../../2020/08/28/sql%E4%BC%98%E5%85%88%E7%BA%A7%E9%97%AE%E9%A2%98/#_1">优先级的问题</a></h3>
<p>因为SELECT的优先级比WHERE低，所以在<code>SELECT</code>里面定义的alias别称就不能在<code>WHERE</code> 里面使用<br />
但可以在<code>ORDER</code>里面使用，因为ORDER 后执行  </p>
<h3 id="_2"><a class="toclink" href="../../2020/08/28/sql%E4%BC%98%E5%85%88%E7%BA%A7%E9%97%AE%E9%A2%98/#_2">常见问题</a></h3>
<div class="highlight"><pre><span></span><code>...
GROUP BY a, b, c
ORDER BY NULL
</code></pre></div>
<div class="highlight"><pre><span></span><code>. . .
GROUP BY a, b, c
ORDER BY a, b, c
</code></pre></div>
<p>在上面的两个例子里的ORDER BY都不会执行，分别解释：</p>
<ol>
<li>第一个例子里的ORDER 是删除GROUP的排序</li>
<li>第二个例子的ORDER是重复了GROUP已经干了的事情</li>
</ol>
<h3 id="_3"><a class="toclink" href="../../2020/08/28/sql%E4%BC%98%E5%85%88%E7%BA%A7%E9%97%AE%E9%A2%98/#_3">验证方法</a></h3>
<p>可以找个在线SQL工具，例如 <code>http://sqlfiddle.com/</code>  </p>
<p>先执行创建数据库命令 
<div class="highlight"><pre><span></span><code><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">new_table</span><span class="p">;</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">new_table</span><span class="o">`</span><span class="w"> </span><span class="p">(</span>
<span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="o">`</span><span class="n">testdecimal</span><span class="o">`</span><span class="w"> </span><span class="nb">decimal</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">));</span>

<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">new_table</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">testdecimal</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1234.45&#39;</span><span class="p">);</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="o">`</span><span class="n">new_table</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">testdecimal</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;1234.45&#39;</span><span class="p">);</span>

<span class="k">set</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span>

<span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; SELECT &quot;</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">new_table</span><span class="p">,(</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; FROM &quot;</span><span class="p">))</span><span class="w"> </span><span class="n">tt</span>
<span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; JOIN1 &quot;</span><span class="p">))</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; ON1 &quot;</span><span class="p">))</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; JOIN2 &quot;</span><span class="p">))</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; ON2 &quot;</span><span class="p">))</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">rand</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="k">where</span><span class="w"> </span><span class="p">((</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; WHERE &quot;</span><span class="p">))</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">IF</span><span class="p">(</span><span class="n">new_table</span><span class="p">.</span><span class="n">testdecimal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1234</span><span class="p">.</span><span class="mi">45</span><span class="p">,</span><span class="k">true</span><span class="p">,</span><span class="k">false</span><span class="p">))</span>
<span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; GROUPBY &quot;</span><span class="p">)),</span><span class="n">id</span>
<span class="k">having</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; HAVING &quot;</span><span class="p">))</span>
<span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">@</span><span class="n">mysqlorder</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">CONCAT</span><span class="p">(</span><span class="o">@</span><span class="n">mysqlorder</span><span class="p">,</span><span class="ss">&quot; ORDERBY &quot;</span><span class="p">));</span>
</code></pre></div></p>
<p>在执行 <code>select @mysqlorder;</code> 结果如下:
<div class="highlight"><pre><span></span><code>@mysqlor`der
(null)
</code></pre></div></p>
<p>可见其优先级顺序为
<div class="highlight"><pre><span></span><code>FROM JOIN1 JOIN2 WHERE ON2 ON1 ORDERBY GROUPBY SELECT WHERE ON2 ON1 ORDERBY GROUPBY SELECT HAVING HAVING
</code></pre></div></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-23 00:00:00+00:00">2020年8月23日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="k8s"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/">搭建k8s集群</a></h2>
<p>引用 https://blog.piaoruiqing.com/2019/09/17/kubernetes-1-installation/
照着文章搭建k8s集群，写得挺好，记录一下自己的搭建方法和问题</p>
<h3 id="_1"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#_1">环境</a></h3>
<ol>
<li>2个kvm虚拟机, 安装的centos7系统</li>
<li>两个虚拟机都配置了双网卡，eth0和eth1， eth0桥接宿主机的bridge， eth1 接入libvirt default NAT网络</li>
<li>官方推荐配置： CPU &gt; 2，内存 &gt; 2G</li>
<li>eth1 的ip 分别为 192.168.122.61, 192.168.122.161</li>
</ol>
<h3 id="masterworker"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#masterworker">Master和Worker 共同步骤</a></h3>
<p>需要在所有节点执行</p>
<h4 id="hostname"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#hostname">修改hostname</a></h4>
<p>编辑hostname
<div class="highlight"><pre><span></span><code>vim /etc/hostname # 修改hostname
</code></pre></div>
配置host文件， 将所有节点都指定host </p>
<h4 id="_2"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#_2">关闭防火墙</a></h4>
<ol>
<li>systemctl disable --now firewalld</li>
<li>修改 /etc/seconfig， 将selinux 配置成disable </li>
</ol>
<h4 id="swap"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#swap">关闭 swap 分区</a></h4>
<ol>
<li>swapoff -a </li>
<li>修改 /etc/fstab， 注释掉swap 记录</li>
</ol>
<h4 id="docker"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#docker">安装docker 配置镜像源</a></h4>
<p>修改 /etc/docker/daemon.json 文件</p>
<div class="highlight"><pre><span></span><code>{
  &quot;registry-mirrors&quot;: [&quot;https://xxxxxxxx.mirror.aliyuncs.com&quot;],
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;
}
</code></pre></div>
<p>### 添加k8s 软件源 </p>
<p>如下添加的aliyun的镜像源</p>
<p>```
 cat &lt;<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
exclude=kube*
EOF
<div class="highlight"><pre><span></span><code>### 安装k8s

安装组件 
</code></pre></div>
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
systemctl enable kubelet &amp;&amp; systemctl start kubelet
<div class="highlight"><pre><span></span><code>### 配置网络
</code></pre></div>
cat &lt;<EOF >  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
<div class="highlight"><pre><span></span><code>上面的步骤需要在主备上执行

## Master 操作 

下面的步骤只在Master节点运行

### 生成k8s初始化配置文件 
</code></pre></div>
[root@k8s-master ~]$ kubeadm config print init-defaults &gt; kubeadm-init.yaml
<div class="highlight"><pre><span></span><code>得到 kubeadm-init.yaml 文件

修改kubeadm-init.yaml 文件
1. 修改 `advertiseAddress: 1.2.3.4` 为本机地址 192.168.122.61
2. 修改 `imageRepository: k8s.gcr.io ` 为 imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers 

修改镜像地址，这样就避免下载k8s 镜像超时

修改后的kubeadm-init.yaml

```yaml
apiVersion: kubeadm.k8s.io/v1beta2
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 10.33.30.92
  bindPort: 6443
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: k8s-master
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns:
  type: CoreDNS
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
kind: ClusterConfiguration
kubernetesVersion: v1.15.0
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.96.0.0/12
scheduler: {}
</code></pre></div></p>
<h4 id="k8s_1"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#k8s_1">下载k8s的组件镜像</a></h4>
<div class="highlight"><pre><span></span><code>kubeadm config images pull --config kubeadm-init.yaml
</code></pre></div>
<h4 id="k8s_2"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#k8s_2">初始化 k8s</a></h4>
<p><div class="highlight"><pre><span></span><code>kubeadm init --config kubeadm-init.yaml
</code></pre></div>
执行无误后，得到worker 节点加入集群的命令 
<div class="highlight"><pre><span></span><code>...
Your Kubernetes control-plane has initialized successfully!
...
Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 10.33.30.92:6443 --token abcdef.0123456789abcdef \
    --discovery-token-ca-cert-hash sha256:2883b1961db36593fb67ab5cd024f451b934fc0e72e2fa3858dda3ad3b225837 
</code></pre></div></p>
<p>记录这个命令， 丢失的话也可以重新执行 <code>kubeadmin create token</code> 找回</p>
<h4 id="kubectl"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#kubectl">配置普通用户执行kubectl 命令</a></h4>
<p>用普通用户执行一下命令， 这样普通用户也能管理集群 
<div class="highlight"><pre><span></span><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre></div></p>
<h4 id="master"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#master">查看Master 节点状态</a></h4>
<p>可见，Master节点未就绪，这是因为还没安装网络组件
<div class="highlight"><pre><span></span><code>[root@k8s-master kubernetes]$ kubectl get node
NAME         STATUS     ROLES    AGE     VERSION
k8s-master   NotReady   master   3m25s   v1.15.3
</code></pre></div></p>
<h4 id="_3"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#_3">配置网络</a></h4>
<ol>
<li>
<p>下载calico 描述文件 
wget https://docs.projectcalico.org/v3.8/manifests/calico.yaml</p>
</li>
<li>
<p>修改calico 描述文件里的serviceSubnet，修改为跟kubeadmin-init.yaml一致
<div class="highlight"><pre><span></span><code>cat kubeadm-init.yaml | grep serviceSubnet:
serviceSubnet: 10.96.0.0/12
</code></pre></div></p>
</li>
</ol>
<p><strong><em>注意</em></strong> <br />
1. calico 的地址必须和 kubeadm-init.yaml 保持一致， kubeadm-init.yaml 默认为 <code>serviceSubnet: 10.96.0.0/12</code>， 而calico的默认地址为<code>192.168.0.0/16</code>, 所以要么修改kubeadmin-init.yaml, 要么修改calico.yaml。
2. 这里的<code>Subnet</code> 不能涵盖到主机的地址范围即不能包含 <code>192.168.122.0/24</code> </p>
<h4 id="calico"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#calico">安装calico</a></h4>
<div class="highlight"><pre><span></span><code>kubectl apply -f calico.yaml 
</code></pre></div>
<h4 id="master_1"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#master_1">查看Master节点</a></h4>
<p>当calico 安装好了， 可以发现Master 节点变为就绪， 至此Master 节点就配置好了
<div class="highlight"><pre><span></span><code>[root@k8s-master ~]$ kubectl get node
NAME         STATUS   ROLES    AGE   VERSION
k8s-master   Ready    master   15m   v1.15.3
</code></pre></div></p>
<h3 id="dashboard"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#dashboard">安装dashboard</a></h3>
<p>之前的步骤安装好了Master节点， 可选择安装dashboard，通过网页来管理集群 </p>
<p>步骤很简单， 先下载dashboard， 再安装 
<div class="highlight"><pre><span></span><code>[root@k8s-master ~]$ wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml
[root@k8s-master ~]$ kubectl apply -f recommended.yaml 
</code></pre></div></p>
<h4 id="dashboard_1"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#dashboard_1">创建dashboard 用户</a></h4>
<p>必须创建用户，然后获取token，才能在集群外访问， 否则必须在Master 的localhost 访问dashboard。 
以下是创建用户的描述文件， 注意namespace， 例如官方的例子是 dashboard， 这样生成的token 不一样</p>
<p>执行安装用户 <code>kubectl apply -f dashboard-adminuser.yaml</code></p>
<div class="highlight"><pre><span></span><code># dashboard-adminuser.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
</code></pre></div>
<p>创建证书， k8s 不允许远程使用http，所以需要用证书访问dashboard </p>
<div class="highlight"><pre><span></span><code>[root@k8s-master ~]$ grep &#39;client-certificate-data&#39; ~/.kube/config | head -n 1 | awk &#39;{print $2}&#39; | base64 -d &gt;&gt; kubecfg.crt
[root@k8s-master ~]$ grep &#39;client-key-data&#39; ~/.kube/config | head -n 1 | awk &#39;{print $2}&#39; | base64 -d &gt;&gt; kubecfg.key
[root@k8s-master ~]$ openssl pkcs12 -export -clcerts -inkey kubecfg.key -in kubecfg.crt -out kubecfg.p12 -name &quot;kubernetes-client&quot;
</code></pre></div>
<p>将生成的 <code>kubecfg.p12</code> 文件导入到集群外的主机，即kvm宿主机上</p>
<div class="highlight"><pre><span></span><code>scp root@10.33.30.92:/root/.kube/kubecfg.p12 ./
</code></pre></div>
<p>在宿主机上使用chrome 的高级功能里可以导入证书  </p>
<p>重启chrome 登录后登录
<div class="highlight"><pre><span></span><code>https://192.168.122.61:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login
</code></pre></div></p>
<p>打开网页后选择输入token， token通过在Master 节点执行一下命令生成， 注意参数 -n kube-system， 需要跟创建用户时的namespace保持一致 
<div class="highlight"><pre><span></span><code>kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)
</code></pre></div></p>
<p>复制token 到网页上，就能登录Dashboard </p>
<h3 id="worker"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#worker">Worker节点加入集群</a></h3>
<p>直接在worker节点执行 </p>
<div class="highlight"><pre><span></span><code>kubeadm join 10.33.30.92:6443 --token abcdef.0123456789abcdef \
    --discovery-token-ca-cert-hash sha256:2883b1961db36593fb67ab5cd024f451b934fc0e72e2fa3858dda3ad3b225837
</code></pre></div>
<p>然后到Master 节点执行以下命令， 这里Name 显示了k8s-worker是因为我们在Hosts文件里指定了ip，所以k8s自动识别到了，否则会显示节点ip</p>
<div class="highlight"><pre><span></span><code>[root@k8s-master ~]$ kubectl get node
NAME         STATUS   ROLES    AGE   VERSION
k8s-master   Ready    master   10h   v1.15.3
k8s-worker   Ready    &lt;none&gt;   96s   v1.15.3
</code></pre></div>
<p>至此集群搭建完毕</p>
<h3 id="_4"><a class="toclink" href="../../2020/08/23/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/#_4">遇到问题</a></h3>
<ol>
<li>因为我的虚拟机配置的双网卡， 需要在calico.yaml 配网卡interface
<div class="highlight"><pre><span></span><code># Cluster type to identify the deployment type
            - name: CLUSTER_TYPE
              value: &quot;k8s,bgp&quot;
            - name: IP_AUTODETECTION_METHOD
              value: &quot;interface=eth1&quot;
</code></pre></div></li>
</ol>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-10 00:00:00+00:00">2020年8月10日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="dockerfile-entrypointcmd"><a class="toclink" href="../../2020/08/10/dockerfile-%E4%B8%ADentrypoint%E5%92%8Ccmd%E7%9A%84%E5%8C%BA%E5%88%AB/">Dockerfile 中ENTRYPOINT和CMD的区别</a></h2>
<p>Dockerfile 中，ENTRYPOINT和CMD来都可以用来设置默认命令，而代替<code>docker run</code>时的命令，也可以一起使用  </p>
<p>单独使用ENTRYPOINT或CMD时，其区别在于对<code>docker run</code>的参数处理:<br />
CMD的命令会被<code>docker run</code>的参数覆盖，而ENTRYPOINT是追加</p>
<p>例如：
<div class="highlight"><pre><span></span><code># image1
FROM ubuntu
ENTRYPOINT [&quot;echo&quot;, &quot;hello world&quot;]
</code></pre></div>
<div class="highlight"><pre><span></span><code># image2
FROM ubuntu
CMD [&quot;echo&quot;, &quot;hello world&quot;]
</code></pre></div></p>
<p>执行结果
<div class="highlight"><pre><span></span><code># docker run image1
hello world

# docker run image1 hostname
0c33ff9af81c
</code></pre></div></p>
<div class="highlight"><pre><span></span><code># docker run image2
hello world

# docker run image2 hostname
hello world 0c33ff9af81c
</code></pre></div>
<h3 id="entrypointcmd"><a class="toclink" href="../../2020/08/10/dockerfile-%E4%B8%ADentrypoint%E5%92%8Ccmd%E7%9A%84%E5%8C%BA%E5%88%AB/#entrypointcmd">实际情况多是entrypoint与cmd组合使用</a></h3>
<p>cmd 为entrypoint 提供默认参数， 即如果'docker run'给了参数时，覆盖CMD参数，否则使用CMD提供的参数</p>
<div class="highlight"><pre><span></span><code>FROM ubuntu
ENTRYPOINT [&quot;top&quot;, &quot;-b&quot;]
CMD [&quot;-c&quot;]
</code></pre></div>
<h3 id="cmdentrypoint"><a class="toclink" href="../../2020/08/10/dockerfile-%E4%B8%ADentrypoint%E5%92%8Ccmd%E7%9A%84%E5%8C%BA%E5%88%AB/#cmdentrypoint">首先说cmd和entrypoint 都有两种模式</a></h3>
<ol>
<li>shell模式， 即没有用数组来传递参数, 直接接命令如 CMD top -p 或者 entrypoint top -p </li>
<li>exec 模式， 即使用数组表示如 CMD ["top", "-p"]， 注意必须用双引号，因为这个是用json来传递的</li>
</ol>
<p>两者区别:<br />
shell模式不会接受命令行参数，而且1号进程是sh，而非如上的top。 这样的话top不能接受到<code>docker stop container</code>时的信号。 
而一般我们写的程序都是捕捉SIGTERM来进行peaceful exit，那么就一定不能使用shell模式</p>
<p>exec模式时， 可以接受docker run image param， 这个param会传递给top作为参数。 而且top 是1号进程，能接收信号。</p>
<p>细微区别： 由于shell模式是先启动sh， 符号解析由shell执行，例如<code>$HOME</code>的展开由shell进行， 而用exec模式时，由docker 进行</p>
<p>总之，推荐使用exec 模式</p>
<h3 id="_1"><a class="toclink" href="../../2020/08/10/dockerfile-%E4%B8%ADentrypoint%E5%92%8Ccmd%E7%9A%84%E5%8C%BA%E5%88%AB/#_1">额外话, 减小镜像体积</a></h3>
<p>使用'\' 或者 '&amp;&amp;' 将命令连起来可以减小镜像层数，从而减小体积。另外build时，单独一行的命令会在新的layer 层执行。有些命令产生的cache，会持续影响到下一层<br />
例如<code>RUN apt-get dist-upgrade -y</code>，如果不想保留cache，需要在build时加入参数<code>docker build --no-cache.</code> </p>
<p>还有最有效减小镜像体积的方式，也常见的是最后用空白镜像，'FROM SCRATCH', 这样把其他的层都干掉了, 只保留一层镜像</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-05 00:00:00+00:00">2020年8月5日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../2020/08/05/%E5%9C%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B9%8B%E4%B8%8A%E5%86%8D%E5%88%9B%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/">在文件系统之上再创一个文件系统</a></h2>
<p>例如在ext3的文件系统上创建一个xfs的文件系统，可以通过回环设备loop， 我们经常通过 <code>mount -o loop</code> 来 mount一个iso文件
但mount 的选项总是ro的</p>
<div class="highlight"><pre><span></span><code>mount: /mnt: WARNING: device write-protected, mounted read-only.
</code></pre></div>
<p>不仅如此， 先在当前文件系统dd出一个文件， 再绑定到loop设备上，然后mount 到某个目录后， 可以进行<code>读写</code>访问</p>
<p><div class="highlight"><pre><span></span><code>[root@ha1 ~]# dd if=/dev/urandom of=file bs=1M count=2
2+0 records in
2+0 records out
2097152 bytes (2.1 MB, 2.0 MiB) copied, 0.0164121 s, 128 MB/s

[root@ha1 ~]# mkfs.ext3  file 
mke2fs 1.44.6 (5-Mar-2019)
Discarding device blocks: done                            
Creating filesystem with 2048 1k blocks and 256 inodes

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (1024 blocks): done
Writing superblocks and filesystem accounting information: done

[root@ha1 ~]# mount -o loop file  /mnt
[root@ha1 ~]# ls /mnt/
lost+found

[root@ha1 mnt]# echo abc &gt; abc
[root@ha1 mnt]# ls
abc  lost+found
</code></pre></div>
绑定loop设备和挂载是由mount 一个命令完成的。</p>
<h3 id="loop"><a class="toclink" href="../../2020/08/05/%E5%9C%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B9%8B%E4%B8%8A%E5%86%8D%E5%88%9B%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/#loop">手动绑定loop</a></h3>
<p><div class="highlight"><pre><span></span><code>[root@ha1 ~]# losetup -f
/dev/loop1

[root@ha1 ~]# losetup -f file 
</code></pre></div>
这样只是将文件绑定了loop设备，需要再挂载到文件目录<code>mount /dev/loop0 /mnt</code></p>
<div class="highlight"><pre><span></span><code>[root@ha1 ~]# ls /mnt/
abc  lost+found
[root@ha1 ~]# 
</code></pre></div>
<p>losetup -f 可以返回第一个未被使用的loop设备名</p>
<h3 id="loop_1"><a class="toclink" href="../../2020/08/05/%E5%9C%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B9%8B%E4%B8%8A%E5%86%8D%E5%88%9B%E4%B8%80%E4%B8%AA%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/#loop_1">创建loop设备</a></h3>
<p>有的系统默认创建了 loop0 .. loop7 的块设备，有的则是在需要的时候创建，比如mount iso的时候发现没有loop设备，则会创建</p>
<ol>
<li>手动创建loop设备通过 <code>mknode</code> 创建</li>
</ol>
<div class="highlight"><pre><span></span><code>mknode  /dev/loop0 b 7 0
mknode  /dev/loop1 b 7 0
...

mknode /dev/loop7 b 7 0
</code></pre></div>
<ol>
<li>如果8个loop0 .. loop8 设备都占用了， 可以再创建loop8</li>
</ol>
<p><div class="highlight"><pre><span></span><code>$sudo mknod /dev/loop8 b 7 8 

$ls -l /dev/loop8
brw-r--r-- 1 root root 7, 8 Jun 11 19:16 /dev/loop8
</code></pre></div>
ps： /dev/loop* 是块设备</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-03 00:00:00+00:00">2020年8月3日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="bash-safety"><a class="toclink" href="../../2020/08/03/bash-safety/">bash safety</a></h2>
<p>不管是大厂还是小厂，总能听到一些误操作新闻<br />
那避免误操作就办法就是写脚本， 然后也有很多脚本出事的新闻, 通常有以下</p>
<h3 id="_1"><a class="toclink" href="../../2020/08/03/bash-safety/#_1">引用了不存在的变量</a></h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nv">ABC_PATH</span><span class="o">=</span>abc

/bin/rm<span class="w"> </span><span class="si">${</span><span class="nv">ABC_PATH</span><span class="si">}</span>/
</code></pre></div>
<p>如果ABC_PATH变量被unset了， 那么就是删除系统了<br />
不过听说<code>/bin/rm /</code> 的操作会可能被系统禁止， 但是<code>/bin/rm /*</code>则肯定能执行成功</p>
<h3 id="_2"><a class="toclink" href="../../2020/08/03/bash-safety/#_2">脚本没有输出</a></h3>
<p>有很多公司用堡垒机来审计操作记录， 但是如果脚本没有输出，那么就不知道执行了什么命令， 再如果脚本也被删除死无对证，那就无法分析了</p>
<h3 id="_3"><a class="toclink" href="../../2020/08/03/bash-safety/#_3">解决办法</a></h3>
<h4 id="bash-set-xeu"><a class="toclink" href="../../2020/08/03/bash-safety/#bash-set-xeu">在bash 脚本前面加上   <code>set -xeu</code></a></h4>
<p>-x 调试模式，bash会输出所有命令
-e 遇到错误就退出
-u 引用了不存在的变量就退出</p>
<h4 id="_4"><a class="toclink" href="../../2020/08/03/bash-safety/#_4">添加默认值</a></h4>
<p>path=${ABC_PATH-/} # default /</p>
<p>这样，当ABC_PATH不存在时，就使用默认值'/'</p>
<h3 id="_5"><a class="toclink" href="../../2020/08/03/bash-safety/#_5">最好的办法</a></h3>
<p>使用ansible， 可以对脚本进行版本管理和review， 可以避免脚本难以维护的问题
使用ide + bash 插件， 可以有提示</p>
<h3 id="_6"><a class="toclink" href="../../2020/08/03/bash-safety/#_6">良好的脚本习惯</a></h3>
<p>除了在脚本前面加上 <code>set -xeu</code>外， 有一些建议 </p>
<ol>
<li>多用<code>&amp;&amp;</code>,<code>||</code> ，少用 <code>;</code> ，如果前面的命令出错，后面就不会执行， 而<code>;</code> 不管  </li>
<li>善用 date， 例如将日志文件加上日期 <code>bash test.sh &gt; log_</code>date +%m_%d_%H_%M_%S``  </li>
<li>脚本放在指定目录，不要与工作目录放在一起， 避免脚本自己被删， 死无对证</li>
<li>定期备份</li>
</ol>
<h2 id="bash"><a class="toclink" href="../../2020/08/03/bash-safety/#bash">bash 的条件判断</a></h2>
<p>有以下脚本,当TMP 不为空的时候，才进行判断值是否大于2</p>
<div class="highlight"><pre><span></span><code>if [ -n &quot;$TMP&quot; -a ${TMP} -gt 2 ];then
        echo &quot;aaaa&quot;
else
        echo &quot;bbbbbbbb&quot;
fi
</code></pre></div>
<p>而当TMP 为空的时候，就会出现 <code>too many arguement</code>。这就说明了bash的执行流程，是先进行整行替换再执行（起码是整行，也许还是全文替换）。
替换后<code>[-n "" -a -gt 2]</code>。导致了报错。
解决这样的问题可以用默认值 TMP=${TMP:=2}, 这样当TMP为空的时候就会自动赋值为2
<div class="highlight"><pre><span></span><code>if [ -n &quot;$TMP&quot; -a ${TMP:=2} -gt 2 ];then
        echo &quot;aaaa&quot;
else
        echo &quot;bbbbbbbb&quot;
fi
</code></pre></div></p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-08-03 00:00:00+00:00">2020年8月3日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="c-register"><a class="toclink" href="../../2020/08/03/c-%E4%B8%AD-register-%E5%85%B3%E9%94%AE%E5%AD%97/">c 中 register 关键字</a></h2>
<p>register 关键字是c/c++ 里面唯一能操作寄存器的指令，强制将数据存放在寄存器里，而不是放在堆栈里，这样读写速度最快。</p>
<p>而汇编语言强大之处是能直接操作寄存器，且可以指定使用哪些寄存器。 </p>
<p>通过汇编一段代码来演示register的作用  </p>
<p>先是c语言代码
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>

<span class="w">    </span><span class="k">register</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
对应的汇编
<div class="highlight"><pre><span></span><code><span class="nl">main:</span>
<span class="nl">.LFB0:</span>
<span class="w">        </span><span class="na">.cfi_startproc</span>
<span class="w">        </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span>
<span class="w">        </span><span class="na">.cfi_def_cfa_offset</span><span class="w"> </span><span class="mi">16</span>
<span class="w">        </span><span class="na">.cfi_offset</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
<span class="w">        </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span>
<span class="w">        </span><span class="na">.cfi_def_cfa_register</span><span class="w"> </span><span class="mi">6</span>
<span class="w">        </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbx</span>
<span class="w">        </span><span class="na">.cfi_offset</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">-24</span>
<span class="w">        </span><span class="nf">movl</span><span class="w">    </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="w">        </span><span class="nf">jmp</span><span class="w">     </span><span class="no">.L2</span>
<span class="nl">.L3:</span>
<span class="w">        </span><span class="nf">movl</span><span class="w">    </span><span class="nv">%ebx</span><span class="p">,</span><span class="w"> </span><span class="mi">-12</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
<span class="w">        </span><span class="nf">addl</span><span class="w">    </span><span class="no">$1</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="nl">.L2:</span>
<span class="w">        </span><span class="nf">cmpl</span><span class="w">    </span><span class="no">$9</span><span class="p">,</span><span class="w"> </span><span class="nv">%ebx</span>
<span class="w">        </span><span class="nf">jle</span><span class="w">     </span><span class="no">.L3</span>
<span class="w">        </span><span class="nf">movl</span><span class="w">    </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">        </span><span class="nf">movq</span><span class="w">    </span><span class="mi">-8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span><span class="w"> </span><span class="nv">%rbx</span>
<span class="w">        </span><span class="nf">leave</span>
<span class="w">        </span><span class="na">.cfi_def_cfa</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">        </span><span class="nf">ret</span>
</code></pre></div></p>
<p>没有register关键字的时候 
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="nl">main:</span>
<span class="nl">.LFB0:</span>
<span class="w">    </span><span class="na">.cfi_startproc</span>
<span class="w">    </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span>
<span class="w">    </span><span class="na">.cfi_def_cfa_offset</span><span class="w"> </span><span class="mi">16</span>
<span class="w">    </span><span class="na">.cfi_offset</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span>
<span class="w">    </span><span class="na">.cfi_def_cfa_register</span><span class="w"> </span><span class="mi">6</span>
<span class="w">    </span><span class="nf">movl</span><span class="w">    </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
<span class="w">    </span><span class="nf">jmp</span><span class="w"> </span><span class="no">.L2</span>
<span class="nl">.L3:</span>
<span class="w">    </span><span class="nf">movl</span><span class="w">    </span><span class="mi">-8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">),</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">movl</span><span class="w">    </span><span class="nv">%eax</span><span class="p">,</span><span class="w"> </span><span class="mi">-4</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
<span class="w">    </span><span class="nf">addl</span><span class="w">    </span><span class="no">$1</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
<span class="nl">.L2:</span>
<span class="w">    </span><span class="nf">cmpl</span><span class="w">    </span><span class="no">$9</span><span class="p">,</span><span class="w"> </span><span class="mi">-8</span><span class="p">(</span><span class="nv">%rbp</span><span class="p">)</span>
<span class="w">    </span><span class="nf">jle</span><span class="w"> </span><span class="no">.L3</span>
<span class="w">    </span><span class="nf">movl</span><span class="w">    </span><span class="no">$0</span><span class="p">,</span><span class="w"> </span><span class="nv">%eax</span>
<span class="w">    </span><span class="nf">popq</span><span class="w">    </span><span class="nv">%rbp</span>
<span class="w">    </span><span class="na">.cfi_def_cfa</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span>
<span class="w">    </span><span class="nf">ret</span>
</code></pre></div>
<p>可见，当register修饰int i时， i的值存放在%ebx里，当没有register修饰时，i的值放在栈里<code>%rbp -8</code>的位置
<code>movl    %ebx, -12(%rbp)</code> 可见当register时， j的值复用了ebx的高32位。 此时的内存如下</p>
<div class="highlight"><pre><span></span><code>--- 栈底
旧的rbp 64位
---
旧的rbx 高32位
---  j
旧的rbx 低32位
---栈顶
</code></pre></div>
<p>rbp表示基地址指针，指向的是函数栈的起始地址，这个起始地址只是对于当前函数而言的<br />
rsp表示栈顶指针，指向当前的栈顶<br />
每次函数调用时(main 函数被内核<code>_start_main__</code>调用):
1. 将调用者的函数栈基地址保存起来 <br />
2. 参数压栈, 可能由调用者压栈，可能由被调用者压栈，影响的是当前的栈顶，继而栈顶影响rbp
3. 将被调用函数当前的栈顶复制给基地址寄存器。新的rbp == rsp即当前的栈顶。相当于构造了新的函数运行环境</p>
<h3 id="rbprsp"><a class="toclink" href="../../2020/08/03/c-%E4%B8%AD-register-%E5%85%B3%E9%94%AE%E5%AD%97/#rbprsp">rbp和rsp</a></h3>
<p>实例代码，main函数中调用foo函数。
<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(){</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<span class="w">  </span><span class="n">foo</span><span class="p">();</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>(gdb) disassemble 
Dump of assembler code for function main:
   0x0000555555555158 &lt;+0&gt;: push   %rbp
   0x0000555555555159 &lt;+1&gt;: mov    %rsp,%rbp
   0x000055555555515c &lt;+4&gt;: mov    $0x0,%eax
=&gt; 0x0000555555555161 &lt;+9&gt;: call   0x555555555139 &lt;foo&gt;
   0x0000555555555166 &lt;+14&gt;:    mov    $0x0,%eax
   0x000055555555516b &lt;+19&gt;:    pop    %rbp
   0x000055555555516c &lt;+20&gt;:    ret
</code></pre></div>
<ol>
<li>main 函数&gt; <code>push %rbp</code> 将栈底寄存器的值保存到堆栈中</li>
<li>main 函数&gt; <code>mov %rsp,%rbp</code> 将当前的栈顶寄存器的值复制到栈底寄存器</li>
<li>main 函数&gt; <code>mov $0x0,%eax</code> 将foo函数的返回值初始化成0</li>
</ol>
<p>进入到foo函数中
<div class="highlight"><pre><span></span><code>(gdb) disassemble 
Dump of assembler code for function foo:
   0x0000555555555139 &lt;+0&gt;: push   %rbp
   0x000055555555513a &lt;+1&gt;: mov    %rsp,%rbp
=&gt; 0x000055555555513d &lt;+4&gt;: lea    0xec0(%rip),%rax        # 0x555555556004
   0x0000555555555144 &lt;+11&gt;:    mov    %rax,%rdi
   0x0000555555555147 &lt;+14&gt;:    mov    $0x0,%eax
   0x000055555555514c &lt;+19&gt;:    call   0x555555555030 &lt;printf@plt&gt;
   0x0000555555555151 &lt;+24&gt;:    mov    $0x1,%eax
   0x0000555555555156 &lt;+29&gt;:    pop    %rbp
   0x0000555555555157 &lt;+30&gt;:    ret
End of assembler dump.
</code></pre></div></p>
<p>附录
<div class="highlight"><pre><span></span><code>General-Purpose Registers

The 64-bit versions of the &#39;original&#39; x86 registers are named:

    rax - register a extended
    rbx - register b extended
    rcx - register c extended
    rdx - register d extended
    rbp - register base pointer (start of stack)
    rsp - register stack pointer (current location in stack, growing downwards)
    rsi - register source index (source for data copies)
    rdi - register destination index (destination for data copies)

The registers added for 64-bit mode are named:

    r8 - register 8
    r9 - register 9
    r10 - register 10
    r11 - register 11
    r12 - register 12
    r13 - register 13
    r14 - register 14
    r15 - register 15

These may be accessed as:

    64-bit registers using the &#39;r&#39; prefix: rax, r15
    32-bit registers using the &#39;e&#39; prefix (original registers: e_x) or &#39;d&#39; suffix (added registers: r__d): eax, r15d
    16-bit registers using no prefix (original registers: _x) or a &#39;w&#39; suffix (added registers: r__w): ax, r15w
    8-bit registers using &#39;h&#39; (&quot;high byte&quot; of 16 bits) suffix (original registers - bits 8-15: _h): ah, bh
    8-bit registers using &#39;l&#39; (&quot;low byte&quot; of 16 bits) suffix (original registers - bits 0-7: _l) or &#39;b&#39; suffix (added registers: r__b): al, bl, r15b

Usage during syscall/function call:

    First six arguments are in rdi, rsi, rdx, rcx, r8d, r9d; remaining arguments are on the stack.
    For syscalls, the syscall number is in rax.
    Return value is in rax.
    The called routine is expected to preserve rsp,rbp, rbx, r12, r13, r14, and r15 but may trample any other registers.
</code></pre></div></p>
<h3 id="_1"><a class="toclink" href="../../2020/08/03/c-%E4%B8%AD-register-%E5%85%B3%E9%94%AE%E5%AD%97/#_1">参考</a></h3>
<p>https://shikaan.github.io/assembly/x86/guide/2024/09/08/x86-64-introduction-hello.html</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../..">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../9/">9</a> <a class="md-pagination__link" href="../10/">10</a> <span class="md-pagination__current">11</span> <a class="md-pagination__link" href="../12/">12</a> <a class="md-pagination__link" href="../13/">13</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
        
          
          <a href="../../tags/" class="md-footer__link md-footer__link--next" aria-label="下一页: Tags">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                Tags
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.indexes", "navigation.tabs.sticky", "navigation.instant", "navigation.instant.progress", "navigation.footer", "toc.follow", "content.code.copy", "content.action.view"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../js/tex-mml-chtml.js"></script>
      
        <script src="../../js/mermaid.min.js"></script>
      
    
  </body>
</html>