
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://energygreek.github.io/notes/blog/archive/2024/">
      
      
        <link rel="prev" href="../2025/">
      
      
        <link rel="next" href="../2023/">
      
      
        
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>2024 - Some Notes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2024" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Some Notes" class="md-header__button md-logo" aria-label="Some Notes" data-md-component="logo">
      
  <img src="../../../assets/bird.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Some Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2024
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="gray" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
    
  
  Blog

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../tags/" class="md-tabs__link">
        
  
  
    
  
  Tag

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Some Notes" class="md-nav__button md-logo" aria-label="Some Notes" data-md-component="logo">
      
  <img src="../../../assets/bird.png" alt="logo">

    </a>
    Some Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Blog
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Blog
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1_2" checked>
        
          
          <label class="md-nav__link" for="__nav_1_2" id="__nav_1_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    归档
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_1_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    归档
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2025/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    2024
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    2024
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        连词和复合句
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      
        linux子进程使用方法
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arduino-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        arduino-cli 使用
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esp32" class="md-nav__link">
    <span class="md-ellipsis">
      
        玩转ESP32
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wpasupplicant-wifi" class="md-nav__link">
    <span class="md-ellipsis">
      
        用 wpasupplicant 管理wifi连接
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pvewindows" class="md-nav__link">
    <span class="md-ellipsis">
      
        pve中给windows扩容
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sedvim" class="md-nav__link">
    <span class="md-ellipsis">
      
        sed和vim替换文本的小区别
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carry-bitoverflow-bit" class="md-nav__link">
    <span class="md-ellipsis">
      
        进位位和溢出位(carry bit/overflow bit)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firefox" class="md-nav__link">
    <span class="md-ellipsis">
      
        firefox 启用手动添加搜索引擎
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streaming-h264-with-rtp" class="md-nav__link">
    <span class="md-ellipsis">
      
        streaming h264 with rtp
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2023
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2022
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2021/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2021
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2020
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2019
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tags/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tag
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        连词和复合句
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      
        linux子进程使用方法
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arduino-cli" class="md-nav__link">
    <span class="md-ellipsis">
      
        arduino-cli 使用
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#esp32" class="md-nav__link">
    <span class="md-ellipsis">
      
        玩转ESP32
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wpasupplicant-wifi" class="md-nav__link">
    <span class="md-ellipsis">
      
        用 wpasupplicant 管理wifi连接
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pvewindows" class="md-nav__link">
    <span class="md-ellipsis">
      
        pve中给windows扩容
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sedvim" class="md-nav__link">
    <span class="md-ellipsis">
      
        sed和vim替换文本的小区别
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#carry-bitoverflow-bit" class="md-nav__link">
    <span class="md-ellipsis">
      
        进位位和溢出位(carry bit/overflow bit)
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firefox" class="md-nav__link">
    <span class="md-ellipsis">
      
        firefox 启用手动添加搜索引擎
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streaming-h264-with-rtp" class="md-nav__link">
    <span class="md-ellipsis">
      
        streaming h264 with rtp
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2024">2024<a class="headerlink" href="#2024" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-12-18 00:00:00+00:00">2024年12月18日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="_1"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/">连词和复合句</a></h2>
<p>英语中，句子(sentence)通常由好个子句子组成，这叫复合句(compound sentense), 由连词和子语句(Clause)、短语(Phase)、单词(Word)组成。</p>
<h3 id="_2"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_2">子句和短语</a></h3>
<p>子句包含完整的主谓， 但短语没有主和谓， 有好多个phase组成。比较长度 Clause &gt; Phase &gt; Word, word很好区别。 短语是不完整的， 而子语句包含了完整的主谓（宾）。
<div class="highlight"><pre><span></span><code>Phrase: Meows so loudly
Clause: That cat meows so loudly
</code></pre></div></p>
<h4 id="_3"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_3">子句当名词</a></h4>
<ul>
<li>She completely understood <code>everything he said</code>. 拆成主谓宾'She understood XXX',  'everything he said' 是宾语XXX， 是一个名词</li>
<li>They remembered <code>what the keynote speaker covered</code>. 同上</li>
</ul>
<h4 id="_4"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_4">子句当副词</a></h4>
<ul>
<li>She fixed the sink <code>without facing difficulty</code>. 拆成主谓宾'She fixed XXX'。'without facing difficulty'修饰动词'fix'， 是副词</li>
<li>The pool was installed <code>after they built the deck</code>. 拆成主谓 'The poll was adj'。 'after they built the deck'是修饰形容词（或was）， 是副词</li>
</ul>
<h4 id="_5"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_5">子句当形容词</a></h4>
<ul>
<li>My friend <code>who rides a motorcycle</code> said it’s a great weekend to ride. 拆成主谓宾'XXX said XXX'。 'who rides a motorcycle' 形容词，形容'My Friend'</li>
<li>No matter what time of day we visit, we always run into the dog <code>that barks</code>. 同上, 形容'dog'</li>
</ul>
<p>子句当名词和形容词时，比较好看出子句的主谓（宾）， 而当副词</p>
<h4 id="_6"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_6">短句是几个单词组成，可以当很多成分</a></h4>
<ul>
<li>She runs <code>every Sunday</code>. 当副词</li>
<li>She was <code>taller than all of her classmates</code>. 当形容词</li>
<li><code>My small dog</code> barks at ducks. 名词</li>
</ul>
<h3 id="_7"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_7">连接词</a></h3>
<p>连接词用来连接子句和短语</p>
<h4 id="_8"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_8">一致关系</a></h4>
<p>for, and, nor, but, or, yet, so</p>
<p><img alt="FANBOYS" src="../../img/fanboys.png" /></p>
<h4 id="_9"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_9">配对关系， 搭配用</a></h4>
<p>both/and, either/or, neither/nor, not only/but, whether/or</p>
<h4 id="_10"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_10">主从关系</a></h4>
<p>after, although, as, as if, as long as, as much as, as soon as, as though, because, before, by the time, even if, even though, if, in order that, in case, in the event that, lest, now that, once, only, only if, provided that, since, so, supposing, that, than, though, till, unless, until, when, whenever, where, whereas, wherever, whether or not, while</p>
<h3 id="_11"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_11">按功能分连接词</a></h3>
<h5 id="_12"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_12">表示强调</a></h5>
<p>indeed</p>
<h5 id="_13"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_13">表示递进</a></h5>
<p>what's more, furthermore</p>
<h5 id="_14"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_14">表示转折</a></h5>
<p>however, but</p>
<h5 id="_15"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_15">表示原因结果</a></h5>
<p>because, as a result</p>
<h3 id="yet"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#yet">yet 相关</a></h3>
<p>yet 一直让我脑子转不过弯， 不知道怎么翻译成中文。例如歌名'Are you bored yet?'， 没yet是‘你无聊吗？’。 当有yet时我以为翻译成’你还无聊吗？‘， 而结果翻译成‘你觉得无聊了吗？’ </p>
<p>gptchat解释“yet表示提问者预期如此，也就是提问者预期被提问者无聊了。”， 所以正确理解应该是： “你应该无聊了吧？” 显然这里yet是副词，修饰bored。</p>
<h4 id="_16"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_16">当副词, 修饰形容词和动词</a></h4>
<p>any yet 但是
nor yet 也不 ; 又不 ; 也没有
but yet 但还是
not yet 还没
why is there yet another problem</p>
<h4 id="_17"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_17">当连词， 连接子句和短语</a></h4>
<p>Yet she 而她已经
Yet Moralistic 但注重道德</p>
<h3 id="_18"><a class="toclink" href="../../%E8%BF%9E%E8%AF%8D%E5%92%8C%E5%A4%8D%E5%90%88%E5%8F%A5/#_18">参考</a></h3>
<p>https://www.grammarly.com/blog/parts-of-speech/conjunctions/
https://www.grammarly.com/blog/sentences/phrases/
https://www.grammarly.com/blog/grammar/clauses/</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-12-17 00:00:00+00:00">2024年12月17日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linux"><a class="toclink" href="../../linux%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">linux子进程使用方法</a></h2>
<p>Linux的exec(3)是一系列函数。之前总是稀里糊涂地用，这次搞清楚了。
<div class="highlight"><pre><span></span><code><span class="w">       </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="w">       </span><span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">environ</span><span class="p">;</span>

<span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">execl</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="p">...</span>
<span class="w">                       </span><span class="cm">/*, (char *) NULL */</span><span class="p">);</span>
<span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">execlp</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="p">...</span>
<span class="w">                       </span><span class="cm">/*, (char *) NULL */</span><span class="p">);</span>
<span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="n">execle</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="p">...</span>
<span class="w">                       </span><span class="cm">/*, (char *) NULL, char *const envp[] */</span><span class="p">);</span>
<span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="nf">execv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">pathname</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">argv</span><span class="p">[]);</span>
<span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="nf">execvp</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">argv</span><span class="p">[]);</span>
<span class="w">       </span><span class="kt">int</span><span class="w"> </span><span class="nf">execvpe</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">argv</span><span class="p">[],</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">envp</span><span class="p">[]);</span>
</code></pre></div></p>
<h3 id="_1"><a class="toclink" href="../../linux%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/#_1">规律</a></h3>
<p>这6个函数可以分为两组'execl组'和'execv组'。 后缀p表示从$PATH中查找程序， 后缀e表示最后一个参数是数组，里面是环境变量。</p>
<h3 id="_2"><a class="toclink" href="../../linux%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/#_2">验证</a></h3>
<p>这里通过c语言和python调用命令<code>cat hello.txt</code>， 验证每个函数。</p>
<p><div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="o">=</span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">execl</span><span class="p">(</span><span class="s">&quot;/usr/bin/cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello-execl.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">execlp</span><span class="p">(</span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello-execlp.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">execle</span><span class="p">(</span><span class="s">&quot;/usr/bin/cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello-execle.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">[]){</span><span class="nb">NULL</span><span class="p">});</span>

<span class="w">  </span><span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">execv</span><span class="p">(</span><span class="s">&quot;/usr/bin/cat&quot;</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">[]){</span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello-execv.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">});</span>

<span class="w">  </span><span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">execvp</span><span class="p">(</span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">[]){</span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello-execvp.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">});</span>

<span class="w">  </span><span class="n">pid</span><span class="o">=</span><span class="n">fork</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">execve</span><span class="p">(</span><span class="s">&quot;/usr/bin/cat&quot;</span><span class="p">,</span><span class="w">  </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">[]){</span><span class="s">&quot;cat&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello-execve.txt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">},</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">[]){</span><span class="nb">NULL</span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
注意当使用选项参数时，选项和参数需要分开成两个字符串。例如<code>grep -n 10 "target" file</code>命令， 调用方法是
<div class="highlight"><pre><span></span><code><span class="n">execlp</span><span class="p">(</span><span class="s">&quot;grep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;grep&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-n&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;10&quot;</span><span class="p">,</span><span class="w">  </span><span class="s">&quot;target&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;file&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></p>
<p>使用环境变量，要用sh来拓展ENV1符号</p>
<div class="highlight"><pre><span></span><code><span class="n">execle</span><span class="p">(</span><span class="s">&quot;/usr/bin/sh&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sh&quot;</span><span class="p">,</span><span class="s">&quot;-c&quot;</span><span class="w"> </span><span class="p">,</span><span class="s">&quot;echo $ENV1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">[]){</span><span class="s">&quot;ENV1=HELLO&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">});</span>
</code></pre></div>
<p>python 的os库的方法更全，且不需要带NULL
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="n">method</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">os</span><span class="p">)</span> <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;exec&quot;</span><span class="p">)]</span>
<span class="p">[</span><span class="s1">&#39;execl&#39;</span><span class="p">,</span> <span class="s1">&#39;execle&#39;</span><span class="p">,</span> <span class="s1">&#39;execlp&#39;</span><span class="p">,</span> <span class="s1">&#39;execlpe&#39;</span><span class="p">,</span> <span class="s1">&#39;execv&#39;</span><span class="p">,</span> <span class="s1">&#39;execve&#39;</span><span class="p">,</span> <span class="s1">&#39;execvp&#39;</span><span class="p">,</span> <span class="s1">&#39;execvpe&#39;</span><span class="p">]</span>
</code></pre></div></p>
<p>实现<code>cat hello.txt</code>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">execlp</span><span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="s2">&quot;hello.txt&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p>使用环境变量, 同样要用sh来拓展ENV1符号
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">env</span><span class="p">[</span><span class="s2">&quot;ENV1&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>
<span class="n">os</span><span class="o">.</span><span class="n">execlpe</span><span class="p">(</span><span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="s2">&quot;-c&quot;</span><span class="p">,</span> <span class="s2">&quot;echo $ENV1&quot;</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
</code></pre></div></p>
<h3 id="_3"><a class="toclink" href="../../linux%E5%AD%90%E8%BF%9B%E7%A8%8B%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/#_3">实用替代方法</a></h3>
<p>exec族的函数都会替换当前进程的堆栈，所以需要用fork生成新的进程。更方便的方法是在c中用system, python中用subprocess</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-12-13 00:00:00+00:00">2024年12月13日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="arduino-cli"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/">arduino-cli 使用</a></h2>
<p>在<a href="../../%E7%8E%A9%E8%BD%ACesp32/">esp32</a>中，使用了arduino-cli来编译和上传代码。这里记录下arduino-cli操作arduino nano的方法和问题</p>
<h3 id="_1"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/#_1">编译</a></h3>
<p>说也非常奇怪，Linux的java GUI版本arduino编译提示找不到头文件'SoftwareSerial.h'， 这个库是arduino自带的。但是不使用GUI的编译按钮而用GUI的输出中的命令编译又正常。 </p>
<p>这是从GUI的IDE的编译上传的输出日志，得到的编译上传命令， 手动执行却正常。
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>~/Arduino
<span class="nv">BUILD_PATH</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="w"> </span>-d<span class="k">)</span>
arduino-builder<span class="w"> </span>-verbose<span class="w"> </span>-compile<span class="w"> </span>-hardware<span class="w"> </span>/usr/share/arduino/hardware<span class="w"> </span>-tools<span class="w"> </span>/usr/share/arduino/hardware/tools/avr<span class="w"> </span>-libraries<span class="w"> </span>/
./Arduino/libraries<span class="w">  </span>-build-cache<span class="w"> </span>./arduino_cache<span class="w"> </span>-build-path<span class="w"> </span><span class="nv">$BUILD_PATH</span><span class="w">  </span>-fqbn<span class="o">=</span>arduino:avr:uno<span class="w">  </span>-prefs<span class="o">=</span>build.warn_data_percentage<span class="o">=</span><span class="m">75</span><span class="w"> </span>./TestSerial/TestSerial.ino
avrdude<span class="w"> </span>-C/etc/avrdude.conf<span class="w"> </span>-v<span class="w"> </span>-patmega328p<span class="w"> </span>-carduino<span class="w"> </span>-P/dev/ttyUSB0<span class="w"> </span>-b115200<span class="w"> </span>-D<span class="w"> </span>-Uflash:w:<span class="si">${</span><span class="nv">BUILD_PATH</span><span class="si">}</span>/TestSerial.ino.hex:i<span class="w"> </span>
</code></pre></div></p>
<p>用arduino-cli编译也正常
<div class="highlight"><pre><span></span><code>arduino-cli compile --fqbn  arduino:avr:nano   TestSerial 
</code></pre></div></p>
<h3 id="_2"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/#_2">上传失败</a></h3>
<p>但是用arduino-cli编译正常，上传失败，提示
<div class="highlight"><pre><span></span><code>arduino-cli upload --fqbn arduino:avr:uno --port /dev/ttyUSB0 TestSerial
avrdude: error at /etc/avrdude.conf:402: syntax error                                                                                                                                           
avrdude: error reading system wide configuration file &quot;/etc/avrdude.conf&quot;                                                                                                                       
Failed uploading: uploading error: exit status 1   
</code></pre></div></p>
<p>后来用verbos输出对比GUI版本的命令，发现两个命令用的avrdude不一样。 一个是/usr/bin/avrdude， 一个是$HOME/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude。两个的版本不一样， 而后者使用了前者的配置文件 /etc/avrdude.conf。所以出现<code>syntax error</code>
<div class="highlight"><pre><span></span><code>arduino-cli upload -v  --fqbn arduino:avr:uno --port /dev/ttyUSB0 TestSerial
&quot;/home/jimery/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude&quot; &quot;-C/etc/avrdude.conf&quot; -v -V -patmega328p -carduino &quot;-P/dev/ttyUSB0&quot; -b115200 -D &quot;-Uflash:w:/home/jimery/.ca
che/arduino/sketches/57AA4FA906132DC236F48CCE34943FA0/TestSerial.ino.hex:i&quot;                                                                                                                     

avrdude: Version 6.3-20190619                                                                                                                                                                   
         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/                                                                                                                            
         Copyright (c) 2007-2014 Joerg Wunsch                                                   

         System wide configuration file is &quot;/etc/avrdude.conf&quot;                                                                                                                                  
avrdude: error at /etc/avrdude.conf:402: syntax error                                                                                                                                           
avrdude: error reading system wide configuration file &quot;/etc/avrdude.conf&quot;                                                                                                                       
Failed uploading: uploading error: exit status 1 
</code></pre></div></p>
<p>最后全部卸载了GUI包括avrdude， 再将$HOME目录的avrdude配置复制到/etc/avrdude.conf， 问题解决了。</p>
<h3 id="archarduino-cliarduino-nano"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/#archarduino-cliarduino-nano">Arch下使用arduino-cli给arduino nano烧代码</a></h3>
<p>arch上的arduino ide 是2版本，基于electron的，但是没有找到适合arduino nano的驱动。 而1版本是基于java的在sway下，菜单都跑到屏幕外面了，没法用。还是回到了arduino-cli</p>
<h4 id="_3"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/#_3">安装配置</a></h4>
<p>安装很简单，最新版就在github上下载编译好的二进制文件。或者用包管理器下载。 再生成配置文件 'arduino-cli config init'，会生成文件 $HOME/.arduino15/arduino-cli.yaml，像之前提到的用esp32</p>
<h4 id="arduino-nano"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/#arduino-nano">为arduino nano创建项目</a></h4>
<p>这里花了很多时间，因为虽然能查到nano的板，但安装不了arduino:avr的驱动，编译上传都不行
<div class="highlight"><pre><span></span><code>$ arduino-cli board listall avr | grep nano
Arduino Nano                     arduino:avr:nano
</code></pre></div></p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>arduino-cli<span class="w"> </span>core<span class="w"> </span>install<span class="w"> </span>arduino:avr
Invalid<span class="w"> </span>argument<span class="w"> </span>passed:<span class="w"> </span>Platform<span class="w"> </span><span class="s1">&#39;arduino:avr&#39;</span><span class="w"> </span>not<span class="w"> </span>found
$<span class="w"> </span>arduino-cli<span class="w"> </span>core<span class="w"> </span>install<span class="w"> </span>arduino:avr::nano
Invalid<span class="w"> </span>argument<span class="w"> </span>passed:<span class="w"> </span>invalid<span class="w"> </span>item<span class="w"> </span>arduino:avr::nano
</code></pre></div>
<p>如果直接编译Sketch,则提示
<div class="highlight"><pre><span></span><code>$ arduino-cli compile MyFirstSketch
arduino-cli compile Couldn&#39;t determine program size
</code></pre></div></p>
<h4 id="-profile"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/#-profile">解决办法 使用'--profile'</a></h4>
<p>在新建的Sketch目录创建文件sketch.yaml，输入下面的内容
<div class="highlight"><pre><span></span><code>profiles:
  nano:
    notes: testing the limit of the AVR platform, may be unstable
    fqbn: arduino:avr:nano
    platforms:
      - platform: arduino:avr (1.8.4)
    libraries:
      - VitconMQTT (1.0.1)
      - Arduino_ConnectionHandler (0.6.4)
      - TinyDHT sensor library (1.1.0)
    port: /dev/ttyUSB0
    port_config:
      baudrate: 115200
</code></pre></div></p>
<p>执行编译命令，指定nano的配置， 会自动下载各种工具avr-gcc avr-g++等
<div class="highlight"><pre><span></span><code>arduino-cli compile --profile nano MyFirstSketch      
</code></pre></div></p>
<p>上传
<div class="highlight"><pre><span></span><code>arduino-cli upload  --fqbn arduino:avr:nano --port /dev/ttyUSB0 MyFirstSketch
</code></pre></div></p>
<h3 id="arduino-cli_1"><a class="toclink" href="../../arduino-cli-%E4%BD%BF%E7%94%A8/#arduino-cli_1">arduino-cli的参考</a></h3>
<p>https://arduino.github.io/arduino-cli/1.2/sketch-project-file/</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-12-06 00:00:00+00:00">2024年12月6日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="esp32"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/">玩转ESP32</a></h2>
<p>ESP32的生态比较好，类似arduino, 但是集成了wifi和蓝牙，有的甚至集成了gps，功能很强大而且便宜。最近淘宝买了一个ESP32-USB-Geek， 带一个LCD屏幕和几个扩展接口，还有闪存口可以读写。</p>
<p><img alt="esp32-usb-geek.png.png" src="../../img/esp32-usb-geek.png.png" /></p>
<h3 id="_1"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#_1">编译烧录</a></h3>
<p>ESP32 有3种方式： 官方的idf， mpy, arduino。</p>
<h4 id="_2"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#_2">官方工具</a></h4>
<p>官方的idf分vscode插件和python脚本， vscode中没有成功，不过idf.py可以编译和烧录。</p>
<p>根据官方文档写的下载安装idf，解压后执行脚本。安装脚本依赖python-venv， 而我最常用vituralenv</p>
<div class="highlight"><pre><span></span><code>bash<span class="w"> </span>v5.3.1/esp-idf/install.sh
</code></pre></div>
<p>进入淘宝店例子, 用cmake管理的。 在跟目录执行</p>
<div class="highlight"><pre><span></span><code>idf.py<span class="w"> </span>set-target<span class="w"> </span>esp32-s3
</code></pre></div>
<p>这种方式支持非常复杂的配置</p>
<div class="highlight"><pre><span></span><code>idf.py<span class="w"> </span>menuconfig
</code></pre></div>
<p>编译刷入</p>
<div class="highlight"><pre><span></span><code>idf.py build

idf.py -p /dev/ttyACM0 flash
</code></pre></div>
<p>官方的方式最能了解物理设备了。看日志发现他生成了bin文件，并从0位置刷入bin文件。</p>
<h4 id="mpy-thonny-ide"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#mpy-thonny-ide">mpy thonny ide</a></h4>
<p>最好用pip安装最新的。 将python上传到esp后，点运行就可以了，还能在REPL中仿真调试，非常方便。</p>
<h4 id="arduino"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#arduino">arduino</a></h4>
<p>arduino ide gui版本编译失败，而且因为是Linux版是用java写的，操作非常慢。改用arduio-cli脚本成功， 官方文档也说了arduino-cli非常强大。这里说脚本使用方法。</p>
<h5 id="_3"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#_3">初始化配置</a></h5>
<ol>
<li>
<p>首先下载压缩包，解压到PATH目录下。</p>
</li>
<li>
<p>初始化配置， <code>arduino-cli config init</code> 可以生成配置文件'~/.arduino15/arduino-cli.yaml'。</p>
</li>
<li>
<p>修改配置文件， 根据淘宝老板说的，ESP32的板子要从另外第三方源中， 因为这个源是githubcontent需要梯子才能访问，修改成如下</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>$ cat ~/.arduino15/arduino-cli.yaml

board_manager:

additional_urls: [&#39;https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json&#39;]



network:

proxy: &#39;socks5://ip:port&#39;
</code></pre></div>
<h5 id="_4"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#_4">安装板子库和依赖库</a></h5>
<p>当没有下载板子时，查看连接的设备会显示Unknown</p>
<div class="highlight"><pre><span></span><code>$ arduino-cli board list

Port Protocol Type Board Name FQBN Core

/dev/ttyACM0 serial Serial Port (USB) Unknown
</code></pre></div>
<p>显示搜索所有板子（包括在添加的第三方源里的）, 这里搜索ESP32核心板， 淘宝老板说，我的开发板叫 ESP32S3 Dev Module</p>
<div class="highlight"><pre><span></span><code>$ arduino-cli board listall ESP32S3 Dev Module

ESP32S3 Dev Module esp32:esp32:esp32s3
</code></pre></div>
<p>安装板子module， 比较大要等待一会。 tips： 板子的包叫module, 软件依赖库叫library</p>
<div class="highlight"><pre><span></span><code>$ arduino-cli core install esp32:esp32
</code></pre></div>
<p>搜索已安装的安装核心板</p>
<div class="highlight"><pre><span></span><code>$ arduino-cli core search esp32

ID Version Name

arduino:esp32 2.0.18-arduino.5 Arduino ESP32 Boards

esp32:esp32 3.0.7 esp32
</code></pre></div>
<h5 id="_5"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#_5">编译</a></h5>
<p>编译淘宝店的例子LCD_Button，要在LCD_Button外面执行</p>
<p>arduino-cli compile --fqbn esp32:esp32:esp32s3 LCD_Button</p>
<h5 id="_6"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#_6">上传到板子</a></h5>
<p>arduino-cli upload -p /dev/ttyACM0 --fqbn esp32:esp32:esp32s3 LCD_Button</p>
<p>有时候失败了，要按住Boot键插入电脑再松开，就能正常上传。</p>
<div class="highlight"><pre><span></span><code>esptool.py v4.6

Serial port /dev/ttyACM0

Connecting...

Traceback (most recent call last):

...

OSError: [Errno 71] Protocol error

Failed uploading: uploading error: exit status 1
</code></pre></div>
<p>看这个日志，原来arduino也是调用的官方的idf工具的esptool脚本。 重新插入USB， 再次查看已连接的开发板就不会显示Unknown了</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>arduino-cli<span class="w"> </span>board<span class="w"> </span>list

Port<span class="w"> </span>Protocol<span class="w"> </span>Type<span class="w"> </span>Board<span class="w"> </span>Name<span class="w"> </span>FQBN<span class="w"> </span>Core

/dev/ttyACM0<span class="w"> </span>serial<span class="w"> </span>Serial<span class="w"> </span>Port<span class="w"> </span><span class="o">(</span>USB<span class="o">)</span><span class="w"> </span>ESP32<span class="w"> </span>Family<span class="w"> </span>Device<span class="w"> </span>esp32:esp32:esp32_family<span class="w"> </span>esp32:esp32
</code></pre></div>
<h3 id="uart"><a class="toclink" href="../../%E7%8E%A9%E8%BD%ACesp32/#uart">连接串口UART</a></h3>
<p>烧录了淘宝店给的串口收发例子，代码非常简单， 然后用我的USB转ttl工具测试成功。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">machine</span>



<span class="n">uart</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">UART</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span> <span class="n">tx</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">43</span><span class="p">),</span> <span class="n">rx</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">44</span><span class="p">))</span>



<span class="k">def</span><span class="w"> </span><span class="nf">send_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

<span class="n">uart</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>



<span class="k">def</span><span class="w"> </span><span class="nf">receive_data</span><span class="p">():</span>

<span class="k">if</span> <span class="n">uart</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">uart</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Received data:&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>




<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

<span class="n">send_data</span><span class="p">(</span><span class="s2">&quot;Hello UART&quot;</span><span class="p">)</span>

<span class="n">receive_data</span><span class="p">()</span>
</code></pre></div>
<p>然而这里是不对的， 串口转TTL和ESP的USB都要连接到电脑上。单连一个都是进了mpy的repl。</p>
<p><img alt="usb-ttl-esp32-uart.png.png" src="../../img/usb-ttl-esp32-uart.png.png" /></p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-07 00:00:00+00:00">2024年5月7日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="wpasupplicant-wifi"><a class="toclink" href="../../wpa%E7%AE%A1%E7%90%86wifi%E6%8E%A5%E5%8F%A3/">用 wpasupplicant 管理wifi连接</a></h2>
<p>用树莓派管理wifi连接的方法有 ：
* 通过配置文件/etc/wpa_supplicant/wpa_supplicant.conf
* raspi-config
* 其它工具iwctl nmtui等</p>
<p>后来发现配置文件管理wifi的优先级不生效，不能选择网络，当然可以用nmtui很方便，不过要安装新包。后来发现了wpa_cli工具很方便，来自安装包wpasupplicant</p>
<h3 id="wpa_cli"><a class="toclink" href="../../wpa%E7%AE%A1%E7%90%86wifi%E6%8E%A5%E5%8F%A3/#wpa_cli">wpa_cli</a></h3>
<p>先要选择网络接口，树莓派就是wlan0。
* 查看可用网络 <code>wpa_cli -i wlan0 list_networks</code>  这个命令会打印可用网络的id和名称
* 选择某个网络 wpa_cli -i wlan0 select_networks &lt;网络id&gt;</p>
<pre><code>wpa_cli 还有交互模式
</code></pre>
<h3 id="_1"><a class="toclink" href="../../wpa%E7%AE%A1%E7%90%86wifi%E6%8E%A5%E5%8F%A3/#_1">参考</a></h3>
<p>https://superuser.com/a/759153</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-04-25 00:00:00+00:00">2024年4月25日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="pvewindows"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/">pve中给windows扩容</a></h2>
<p>当初创建windows时给的40G硬盘，就一个分区，后来装了一些软件，发现不够用了，就第一次扩容，然后加了另一个分区。后来有些东西必须放在C盘里，这次扩容就比较复杂些。</p>
<h3 id="_1"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/#_1">第一次扩容</a></h3>
<p>pve的web界面点击硬盘的resize可以修改硬盘大小，这个硬盘实际上是一个lvm块设备，而对于虚拟机Windows而言就是硬盘变大了。</p>
<p>硬盘加大后，进入windows磁盘管理，发现Windows已经有3个区：efi，C盘，恢复分区。为了方便直接加了一个D盘。</p>
<p>备注：pve的虚拟机安装在块设备上，而qemu是用文件（raw or qcow2），所以qemu的虚拟机可以复制移动，不过pve支持异地部署。</p>
<h3 id="_2"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/#_2">第二次扩容</a></h3>
<p>这次扩容是为了增加C盘大小，而C盘后面有恢复分区和D分区。不得不在gparted 中执行:
1. 删除D分区
2. 移动恢复分区到磁盘末尾
3. 拓展C盘大小。
gparted操作很方便，不过windows启动不成功，通过windows安装iso修复之后正常了，恢复分区也还在。</p>
<h3 id="virtual-vnc-gparted"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/#virtual-vnc-gparted">virtual vnc 可视化打开gparted</a></h3>
<p>因为pve没有连接显示器，只能用虚拟vnc，远程连接到pve桌面。</p>
<h3 id="tigervnc"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/#tigervnc">安装tigervnc服务端</a></h3>
<p>pve只需要安装服务端，tigervnc-standalone-server。本地电脑安装客户端，选择很多例如 remmina。</p>
<h3 id="_3"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/#_3">启动</a></h3>
<p>创建密码后启动vnc 服务端失败，提示没有桌面。原因是没有安装桌面环境更没有启动桌面，好在tigervnc 支持指定可视化进程（xVNC就不支持这种方式）。
<div class="highlight"><pre><span></span><code>tigervncserver -xstartup /usr/sbin/gparted  --  /dev/dm-15
</code></pre></div></p>
<p>这里直接给的gparted可执行文件路径和参数，<code>--</code>表示后面的参数是给gparted的，不是给tigervncserver的，/dev/dm-15是要操作的windows磁盘，也能在gparted界面里面再选。</p>
<h3 id="remmina"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/#remmina">remmina设置窗口大小</a></h3>
<p>tigervncserver默认启动1024x768的窗口，当内容多时不方便。重新启动
<div class="highlight"><pre><span></span><code>tigervncserver -geometry 1920x1080 -xstartup /usr/sbin/gparted  --  /dev/dm-15
</code></pre></div></p>
<p>但是重新连接发现窗口还是很小，以为参数不生效。后来发现这时候窗口右下角可以拖动，手动拖成满屏</p>
<h3 id="gparted"><a class="toclink" href="../../pve%E4%B8%AD%E7%BB%99windows%E6%89%A9%E5%AE%B9/#gparted">gparted问题</a></h3>
<p>启动gparted后出现没有光标，后面按了鼠标右键就恢复X光标了。arch wiki里面有解决<a href="https://wiki.archlinux.org/title/TigerVNC#:~:text=If%20no%20mouse%20cursor%20is%20visible">办法</a> </p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-04-25 00:00:00+00:00">2024年4月25日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="sedvim"><a class="toclink" href="../../sed%E5%92%8Cvim%E6%9B%BF%E6%8D%A2%E6%96%87%E6%9C%AC%E7%9A%84%E5%B0%8F%E5%8C%BA%E5%88%AB/">sed和vim替换文本的小区别</a></h2>
<h3 id="vimsed"><a class="toclink" href="../../sed%E5%92%8Cvim%E6%9B%BF%E6%8D%A2%E6%96%87%E6%9C%AC%E7%9A%84%E5%B0%8F%E5%8C%BA%E5%88%AB/#vimsed">替换招行的账单中发现vim和sed区别</a></h3>
<p>在vim中
1. <code>:%s/\n/,/g</code>
2. <code>:% s/\t,\t,\t,\t,/\r/g</code>
用sed:
<code>cat bill.txt| sed -z 's/\n/,/g'  | sed 's/\t,\t,\t,\t,/\n/g'</code></p>
<h3 id="_1"><a class="toclink" href="../../sed%E5%92%8Cvim%E6%9B%BF%E6%8D%A2%E6%96%87%E6%9C%AC%E7%9A%84%E5%B0%8F%E5%8C%BA%E5%88%AB/#_1">可见</a></h3>
<ol>
<li>vim中匹配换行符用<code>\n</code>, 而替换用<code>\r</code>。替换成<code>\n</code>在vim中显示成<code>^@</code></li>
<li>sed 中的换行符统一用<code>\n</code>，这比vim好，但sed 中不能直接用<code>\n</code>匹配，还得加上 -z 参数。</li>
</ol>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-04-12 00:00:00+00:00">2024年4月12日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="carry-bitoverflow-bit"><a class="toclink" href="../../%E8%BF%9B%E4%BD%8D%E4%BD%8D%E5%92%8C%E6%BA%A2%E5%87%BA%E4%BD%8Dcarry-bitoverflow-bit/">进位位和溢出位(carry bit/overflow bit)</a></h2>
<p>这两个标志位是运算器(alu)的组成部分，因为运算器在执行加法时，要关注两个问题：是否进位超了；是否溢出了。这两个问题很相似，但有区别。</p>
<h3 id="_1"><a class="toclink" href="../../%E8%BF%9B%E4%BD%8D%E4%BD%8D%E5%92%8C%E6%BA%A2%E5%87%BA%E4%BD%8Dcarry-bitoverflow-bit/#_1">加法和减法</a></h3>
<p>对于减法而言，实际是将减数翻转，然后执行加法。即：
<div class="highlight"><pre><span></span><code>1 - 1 = 1 + (-1)
</code></pre></div></p>
<p>运算器做减法时要比较两数的绝对值大小再进行减法，符号设置成大的数的符号，例如
<div class="highlight"><pre><span></span><code>2 - 1 =&gt; 2 - 1 = 1 =&gt; 符号位设置成2的符号位
1 - 2 =&gt; 2 - 1 = 1 =&gt; 符号位设置成1的符号位
</code></pre></div></p>
<p>数字在内存中存放的是“补码”形式，补码很多好处，对于正数而言，源码、反码、补码的二进制形式相同。补码统一了+0和-0的形式，而且补码适合做减法运算。
<div class="highlight"><pre><span></span><code>+0/-0
原码: 0000 0000/ 1000 0000
反码: 0000 0000/ 1111 1111 正数不变，负数的符号位不变，其它位取反
补码: 0000 0000/10000 0000 正数不变，负数先转反码再加1，进位位丢掉后相同
</code></pre></div></p>
<h3 id="_2"><a class="toclink" href="../../%E8%BF%9B%E4%BD%8D%E4%BD%8D%E5%92%8C%E6%BA%A2%E5%87%BA%E4%BD%8Dcarry-bitoverflow-bit/#_2">进位标志位</a></h3>
<p>进位位用来标志两数相加产生的进位超过了位数，例如 1+1 = 10，要多一位，如果运算器是8位的，执行 11111111+1的运算，就要进位，且超过了位数，这时候进位位就会置1。</p>
<p>判断方法 <strong>Carry = (Result &gt;&gt; n) &amp; 1</strong></p>
<h3 id="_3"><a class="toclink" href="../../%E8%BF%9B%E4%BD%8D%E4%BD%8D%E5%92%8C%E6%BA%A2%E5%87%BA%E4%BD%8Dcarry-bitoverflow-bit/#_3">溢出标志位</a></h3>
<p>溢出位只针对有符号数的运算，有符号数的第一位表示正负，0代表正，1代表负，其它位表示值。当值的部分想加产生进位时，导致符号位覆盖。</p>
<p>判断方法（就8位而言） <strong>Overflow = (Result [7bit] XOR Op1[7bit] XOR Op2[7bit])</strong></p>
<p>溢出位置1时，虽然符号为不正确，但其值是正确的（包含符号位）。</p>
<h3 id="_4"><a class="toclink" href="../../%E8%BF%9B%E4%BD%8D%E4%BD%8D%E5%92%8C%E6%BA%A2%E5%87%BA%E4%BD%8Dcarry-bitoverflow-bit/#_4">参考</a></h3>
<p><a href="https://blog.csdn.net/weixin_44718794/article/details/106252940">源码/反码/补码</a>
<a href="https://www.circuitsgallery.com/carry-bit-vs-overflow-bit/?utm_source=pocket_saves">进位位/溢出位</a></p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-03-08 00:00:00+00:00">2024年3月8日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="firefox"><a class="toclink" href="../../firefox-%E5%90%AF%E7%94%A8%E6%89%8B%E5%8A%A8%E6%B7%BB%E5%8A%A0%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/">firefox 启用手动添加搜索引擎</a></h2>
<ol>
<li>Open a new tab and type about:config in the address bar</li>
<li>In the search box type: browser.urlbar.update2.engineAliasRefresh</li>
<li>Click on the little + symbol on the right. This is what it should look like after you pressed it: boolean true value after pressing plus sign</li>
<li>Go to firefox Settings → Search. Or enter this in the address bar: about:preferences#search</li>
<li>In the "Search Shortcuts" section you should notice a new "add" button.</li>
</ol>
<h3 id="_1"><a class="toclink" href="../../firefox-%E5%90%AF%E7%94%A8%E6%89%8B%E5%8A%A8%E6%B7%BB%E5%8A%A0%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/#_1">参考</a></h3>
<p>https://superuser.com/questions/7327/how-to-add-a-custom-search-engine-to-firefox</p>
    
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-02-07 00:00:00+00:00">2024年2月7日</time></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="streaming-h264-with-rtp"><a class="toclink" href="../../streaming-h264-with-rtp/">streaming h264 with rtp</a></h2>
<p>这里记录了使用ffmpeg来发送h264的rtp流，主要问题是处理pps和sps的发送，看了非常多的文档和例子包括gptchat，直到用gdb跟ffmpeg才找到解决办法。</p>
<h3 id="_1"><a class="toclink" href="../../streaming-h264-with-rtp/#_1">背景</a></h3>
<p>公司的有个发送视频彩铃的业务，需要向终端发送h264。开始想法是创建ffmpeg进程来发送，不过发现进程太好资源并发上不去。后来用写代码来多线程发送。</p>
<h4 id="sdp"><a class="toclink" href="../../streaming-h264-with-rtp/#sdp">sdp协商转码问题</a></h4>
<p>sdp协商结果会有不同的分辨率、等级、质量之类的参数(pps/sps)，为了避免转码，提前制作了不同参数的视频。不过后来发现只要正确发送pps/sps，终端都能正确解码，不是必须按sdp里的视频参数。</p>
<h4 id="ffmpeg"><a class="toclink" href="../../streaming-h264-with-rtp/#ffmpeg">用ffmpeg发送</a></h4>
<p>开始直接使用命令ffmpeg发送，发现终端不能解码。对比正常的rtp流发现缺少了pps/sps。
<div class="highlight"><pre><span></span><code>ffmpeg -i video.mp4 -an -c:v copy -f rtp rtp://ip:port
</code></pre></div>
一番搜索发现ffmpeg将pps/sps等参数写到sdp中(out-of-band)，还用base64编码了。
<div class="highlight"><pre><span></span><code>a=fmtp:96 packetization-mode=1; sprop-parameter-sets=Z2QAKKzRAHgCJ+XAWoCAgKAAAAMAIAAAB4HjBiJA,aOvvLA==; profile-level-id=640028
</code></pre></div></p>
<p>ffplay等播放软件会解析sdp，载入pps/sps，所以正确解码，但是sip场景下只能通过rtp来发送sps/pps(in-band)。 后来发现用ffmpeg的'bit stream filter'能解决问题</p>
<div class="highlight"><pre><span></span><code>ffmpeg -i video.mp4 -an -c:v copy -bsf h264_mp4toannexb -f rtp rtp://ip:port
</code></pre></div>
<p>即使不转码，使用ffmpeg进程发送视频，在两核的系统中大概只能发送十几路。</p>
<h4 id="_2"><a class="toclink" href="../../streaming-h264-with-rtp/#_2">代码实现发送</a></h4>
<p>基于ffmpeg的示例代码'doc/example/remux.c', 将原来写文件改为rtp即可。因为还没有用到'h264_mp4toannexb'，还不会发送pps和sps。</p>
<h5 id="bsf"><a class="toclink" href="../../streaming-h264-with-rtp/#bsf">关键问题就是如何使用这个bsf</a></h5>
<p>网上看到的例子包括用gptchat生成的例子，都是类似下面的步骤。</p>
<div class="highlight"><pre><span></span><code># 搜索bsf
av_bsf_get_by_name(&quot;h264_mp4toannexb&quot;)
# 创建bsf的上下文
av_bsf_alloc(bsf, &amp;bsf_ctx)
# 从输入的format上下文中复制编码参数
avcodec_parameters_copy(bsf_ctx-&gt;par_in, input_ctx-&gt;streams[video_stream_idx]-&gt;codecpar)
# 初始化bsf上下文
av_bsf_init(bsf_ctx)
# 读入packet
av_read_frame(input_ctx, &amp;pkt)
# 送到bsf中处理
av_bsf_send_packet(bsf_ctx, pkt)
# 取出处理后的pkt
av_bsf_receive_packet(bsf_ctx, pkt)
# 发送rtp
</code></pre></div>
<p>抓包发现还是没有发送PPS/SPS, 而且第一个NALU是SEI，并且是坏的(Malformed)。调试发现bsf确实成功将SEI从AVCC转换成了AnnexB形式，也在SEI后追加了PPS和SPS。
<div class="highlight"><pre><span></span><code>(gdb) x/150bx pkt-&gt;data
0x5555556da310: 0x00    0x00    0x00    0x01    0x06    0x05    0x2e    0xdc
0x5555556da318: 0x45    0xe9    0xbd    0xe6    0xd9    0x48    0xb7    0x96
0x5555556da320: 0x2c    0xd8    0x20    0xd9    0x23    0xee    0xef    0x78
0x5555556da328: 0x32    0x36    0x34    0x20    0x2d    0x20    0x63    0x6f
0x5555556da330: 0x72    0x65    0x20    0x31    0x35    0x35    0x20    0x72
0x5555556da338: 0x32    0x39    0x30    0x31    0x20    0x37    0x64    0x30
0x5555556da340: 0x66    0x66    0x32    0x32    0x00    0x80    0x00    0x00
0x5555556da348: 0x00    0x01    0x67    0x64    0x00    0x28    0xac    0xd1
0x5555556da350: 0x00    0x78    0x02    0x27    0xe5    0xc0    0x5a    0x80
0x5555556da358: 0x80    0x80    0xa0    0x00    0x00    0x03    0x00    0x20
0x5555556da360: 0x00    0x00    0x07    0x81    0xe3    0x06    0x22    0x40
0x5555556da368: 0x00    0x00    0x00    0x01    0x68    0xeb    0xef    0x2c
0x5555556da370: 0x00    0x00    0x01    0x65    0x88    0x84    0x02    0xff
0x5555556da378: 0x91    0x3c    0x4a    0x51    0x5b    0xfd    0x02    0x3f
0x5555556da380: 0xc1    0x67    0x8d    0xc0    0x94    0x98    0xee    0x7d
0x5555556da388: 0x43    0x23    0xc0    0x4f    0xf7    0x56    0x37    0xfc
0x5555556da390: 0xf1    0xf3    0xd3    0x83    0x03    0xa9    0x6d    0xd2
0x5555556da398: 0x07    0xcf    0x19    0xa2    0x1e    0x29    0x64    0xfe
0x5555556da3a0: 0x1f    0x8e    0xd6    0x71    0x5f    0x33
</code></pre></div>
<code>0x00 0x00 0x00 0x01</code>是annexb格式的起始码，第一个NALU是0x06(SEI)，第二个NALU是0x07(SPS)，第三个是0x08(PPS)。问题出在rtp打包的<code>ff_rtp_send_h264_hevc</code>。这里判断出<code>s-&gt;nal_length_size</code>不是0而是4, 所以还是以AVCC格式的首四个字节代表长度来解析pkt，而这是pkt是annexB格式了，前四个字节就是0x00, 0x00, 0x00, 0x01。所以打包错误。 问题怎么使rtp按annexB来打包，为什么<code>nal_length_size</code>是4不是0。</p>
<div class="highlight"><pre><span></span><code>void ff_rtp_send_h264_hevc(AVFormatContext *s1, const uint8_t *buf1, int size)
{
    const uint8_t *r, *end = buf1 + size;
    RTPMuxContext *s = s1-&gt;priv_data;

    s-&gt;timestamp = s-&gt;cur_timestamp;
    s-&gt;buf_ptr   = s-&gt;buf;
    if (s-&gt;nal_length_size)
        r = ff_avc_mp4_find_startcode(buf1, end, s-&gt;nal_length_size) ? buf1 : end;
    else
        r = ff_avc_find_startcode(buf1, end);
</code></pre></div>
<p>找到初始化rtp的初始化函数<code>rtp_write_header</code>，发现设置<code>nal_length_size</code>的地方，原来判断extradata，如果第一个字节是1,则按avcc打包。
<div class="highlight"><pre><span></span><code>    case AV_CODEC_ID_H264:
        /* check for H.264 MP4 syntax */
        if (st-&gt;codecpar-&gt;extradata_size &gt; 4 &amp;&amp; st-&gt;codecpar-&gt;extradata[0] == 1) {
            s-&gt;nal_length_size = (st-&gt;codecpar-&gt;extradata[4] &amp; 0x03) + 1;
        }
        break;
</code></pre></div>
而当前的extradata是类似avcc的（又不同于AVCC, 因为多一个header)，第一个字节等于1，而通过调试ffmpeg_g到这里时，extradata是annexB格式，即首4个字节是0x00,0x00,0x00,0x01。关于extradata格式的问题，从开始我就发现刚初始化时，extradata就是0x01开头，那么问题ffmpeg_g的extradata什么时候变的，再次调试发现，bsf初始化跟上面的不同。在ffmpeg_g中bsf初始化在fftools/ffmpeg_mux.c文件中:
<div class="highlight"><pre><span></span><code># fftools/ffmpeg_mux.c
static int bsf_init(MuxStream *ms)
{
    OutputStream *ost = &amp;ms-&gt;ost;
    AVBSFContext *ctx = ms-&gt;bsf_ctx;
    int ret;

    if (!ctx)
        return avcodec_parameters_copy(ost-&gt;st-&gt;codecpar, ost-&gt;par_in);

    ret = avcodec_parameters_copy(ctx-&gt;par_in, ost-&gt;par_in);
    if (ret &lt; 0)
        return ret;

    ctx-&gt;time_base_in = ost-&gt;st-&gt;time_base;

    ret = av_bsf_init(ctx);
    if (ret &lt; 0) {
        av_log(ms, AV_LOG_ERROR, &quot;Error initializing bitstream filter: %s\n&quot;,
               ctx-&gt;filter-&gt;name);
        return ret;
    }

    ret = avcodec_parameters_copy(ost-&gt;st-&gt;codecpar, ctx-&gt;par_out);
    if (ret &lt; 0)
        return ret;
    ost-&gt;st-&gt;time_base = ctx-&gt;time_base_out;

    ms-&gt;bsf_pkt = av_packet_alloc();
    if (!ms-&gt;bsf_pkt)
        return AVERROR(ENOMEM);

    return 0;
}
</code></pre></div>
发现，ffmpeg的bsf初始化多一个步骤，将bsf的par_out拷贝到输出AVstream中。而这par_out中的extradata就是我们要的annexB格式！
<div class="highlight"><pre><span></span><code>ret = avcodec_parameters_copy(ost-&gt;st-&gt;codecpar, ctx-&gt;par_out);
</code></pre></div></p>
<p>问题找到答案了，1是初始化rtp muxer前先初始化bsf，2是初始化bsf后将par_out拷贝回rtp muxer，再初始化rtp muxer。</p>
<h5 id="_3"><a class="toclink" href="../../streaming-h264-with-rtp/#_3">正确例子</a></h5>
<p>基于ffmpeg的doc/example/remux.c 删除了错误处理。只关心h264，所以输入输出都只处理index=0的包。
<div class="highlight"><pre><span></span><code>int main(int argc, char **argv) {
  const AVOutputFormat *ofmt = NULL;
  AVFormatContext *ifmt_ctx = NULL, *ofmt_ctx = NULL;
  AVPacket *pkt = NULL;
  const char *in_filename, *out_filename;
  int ret = 0;
  in_filename = &quot;video.mp4&quot;;
  out_filename = &quot;rtp://127.0.0.1:10020&quot;;
  pkt = av_packet_alloc();
  ret = avformat_open_input(&amp;ifmt_ctx, in_filename, 0, 0);
  ret = avformat_find_stream_info(ifmt_ctx, 0);
  av_dump_format(ifmt_ctx, 0, in_filename, 0);

  // 创建输出rtp上下文，不初始化
  avformat_alloc_output_context2(&amp;ofmt_ctx, NULL, &quot;rtp&quot;, out_filename);
  // 初始化bsf
  const AVBitStreamFilter *bsf_stream_filter =
      av_bsf_get_by_name(&quot;h264_mp4toannexb&quot;);
  AVBSFContext *bsf_ctx = NULL;
  ret = av_bsf_alloc(bsf_stream_filter, &amp;bsf_ctx);
  ret =
      avcodec_parameters_copy(bsf_ctx-&gt;par_in, ifmt_ctx-&gt;streams[0]-&gt;codecpar);
  ret = av_bsf_init(bsf_ctx);

  ofmt = ofmt_ctx-&gt;oformat;
  AVStream *out_stream = avformat_new_stream(ofmt_ctx, NULL);
  // 关键在这！！ 原来是从ifmt_ctx的stream中拷贝codecpar，改成从bsf中拷贝
  // ret = avcodec_parameters_copy(out_stream-&gt;codecpar, in_codecpar);
  ret = avcodec_parameters_copy(out_stream-&gt;codecpar, bsf_ctx-&gt;par_out);
  out_stream-&gt;codecpar-&gt;codec_tag = 0;
  av_dump_format(ofmt_ctx, 0, out_filename, 1);
  if (!(ofmt-&gt;flags &amp; AVFMT_NOFILE)) {
    ret = avio_open(&amp;ofmt_ctx-&gt;pb, out_filename, AVIO_FLAG_WRITE);
  }
  // 初始化bsf后再初始化rtp
  ret = avformat_write_header(ofmt_ctx, NULL);

  while (1) {
    AVStream *in_stream, *out_stream;
    ret = av_read_frame(ifmt_ctx, pkt);
    if (pkt-&gt;stream_index != 0) {
      continue;
    }
    in_stream = ifmt_ctx-&gt;streams[pkt-&gt;stream_index];
    out_stream = ofmt_ctx-&gt;streams[pkt-&gt;stream_index];
    log_packet(ifmt_ctx, pkt, &quot;in&quot;);

    av_bsf_send_packet(bsf_ctx, pkt);
    av_bsf_receive_packet(bsf_ctx, pkt);
    /* copy packet */
    av_packet_rescale_ts(pkt, in_stream-&gt;time_base, out_stream-&gt;time_base);
    pkt-&gt;pos = -1;
    log_packet(ofmt_ctx, pkt, &quot;out&quot;);
    ret = av_interleaved_write_frame(ofmt_ctx, pkt);
  }

  av_write_trailer(ofmt_ctx);
}
</code></pre></div></p>
<h4 id="h264_mp4toannexb"><a class="toclink" href="../../streaming-h264-with-rtp/#h264_mp4toannexb">h264_mp4toannexb</a></h4>
<p>这个bsf将从mp4文件中读取的avcc格式的packet转换成annexb格式的packet。调试发现第一个读出来的包是SEI一个I帧，通过bsf处理后，会在SEI后面追加上PPS和SPS信息。而读取mp4文件时，sps/pps在extradata中。</p>
<h4 id="_4"><a class="toclink" href="../../streaming-h264-with-rtp/#_4">相关知识</a></h4>
<p>这些知识反复看来看去，总也不能贯穿起来，直到问题解决才算明白。</p>
<h5 id="nalu"><a class="toclink" href="../../streaming-h264-with-rtp/#nalu">NALU</a></h5>
<p>NALU是真正用来保存h264视频信息的，包括I帧，P/B帧，PPS，SEI，SPS等。NALU由两部分组成：头（1字节）和payload，头中包含nalu的类型。h264规范只定义了NALU本身单元，但没有定义怎么保存NALU单元，所以有了两种格式保存NALU，AVCC和AnnexB。</p>
<h6 id="nalu_1"><a class="toclink" href="../../streaming-h264-with-rtp/#nalu_1">NALU类型</a></h6>
<p>NAL unit type的值和说明，类型后面跟payload。详细参见在Rec. ITU-T H.264文件的63页，这里展示常用的
* 5,Coded slice of an IDR picture (I帧)
* 6,Supplemental enhancement information (SEI)
* 7,Sequence parameter set (SPS) 
* 8,Picture parameter set (PPS)
* 24,Single-Time Aggregation Packet(STAP-A)</p>
<p>从抓包看到SPS算上payload的长度为30，PPS算上payload的长度为4。不知道长度是不是固定的。</p>
<h6 id="stap-a"><a class="toclink" href="../../streaming-h264-with-rtp/#stap-a">STAP-A</a></h6>
<p>STAP-A是多个NALU的聚合(Aggregation)，即这个NALU的payload里是多个NALU。STAP-A类型的NAL用来发送PPS/SPS/SEI等多种聚合。因为这些单元都很小。STRAP-A类型的header也是一个字节，但是payload里面有多个NALU，并且每个NALU前面用2字节来表示这个NALU的大小。
<div class="highlight"><pre><span></span><code>|STAP-A header|NALU-1 size|NALU-1|NALU-2 size|NALU-2|
</code></pre></div></p>
<p>NALU-1中又有header和payload。</p>
<h5 id="avccannexb"><a class="toclink" href="../../streaming-h264-with-rtp/#avccannexb">AVCC和AnnexB</a></h5>
<p>上面说了规范没有定义怎么保存NALU，所以有了这两个格式，他们两是平等关系，只有保存的格式不同而已。AVCC用来保存，annexB用来流传输。
* AVCC用1~4个字节来表示NALU的长度，长度后面是NALU。读取方法是先读长度，再读取NALU。再读下一个长度，再读下一个NALU...
* 而annexb用<code>0x00,0x00,0x00,0x01</code>或者<code>0x00,0x00,0x01</code>的起始码(start code)来分隔不同的NALU，所以方法是先读起始码，再一直读，直到发现下一个起始码，表示这个NALU结束，下一个NALU开始。</p>
<p>ffmpeg使用中发现，AVCC一般用4字节表示NALU的长度，具体多少字节，在ffmpeg的extradata中有定义。annexB也是用4字节的起始码，也就是0x00,0x00,0x00,0x01。</p>
<h5 id="fragmentation-units-fus"><a class="toclink" href="../../streaming-h264-with-rtp/#fragmentation-units-fus">Fragmentation Units (FUs) 分片</a></h5>
<p>FU就是网络分片，因为I帧是一个完整的图片，所以非常大，为了保证udp不丢包，所以要分次发送。 第一个分片的FU的头设置了Start bit， 最后一个分片的FU头设置了END bit。分片是在rtp muxer中完成，注意ffmpeg中一个packet可以包含多个音频帧，但是只包含一个帧，直到发送rtp之前，一个packet总是完整的一帧视频（I/P/B）。 对于比较小的packet，例如聚合了PPS/SPS等信息的STAP-A包，不需要分片。</p>
<h5 id="extradata"><a class="toclink" href="../../streaming-h264-with-rtp/#extradata">extradata</a></h5>
<p>上面很多次提到ffmpeg的extradata, 就是AVCodecParameters.extradata，它的长度是AVCodecParameters.extradata_size。在读取mp4文件的时候，ffmpeg会自动填充，在解码rtp的时候可能就需要手动填充了。extradata的比特位如下，首先是6字节的头，然后是多个SPS类型的NALU（2字节的长度分割多个NALU），再然后是PPS类型的NALU个数，最后是PPS类型的多个NALU(2字节的长度分割多个NALU）。
<div class="highlight"><pre><span></span><code>bits    
8   version ( always 0x01 )
8   avc profile ( sps[0][1] )
8   avc compatibility ( sps[0][2] )
8   avc level ( sps[0][3] )
6   reserved ( all bits on )
2   NALULengthSizeMinusOne
3   reserved ( all bits on )
5   number of SPS NALUs (usually 1)

repeated once per SPS:
  16         SPS size
  variable   SPS NALU data

8   number of PPS NALUs (usually 1)

repeated once per PPS:
  16       PPS size
  variable PPS NALU data
</code></pre></div></p>
<p>里面包含了一个或多个PPS/SPS(NALU)，但保存的格式，既不是AVCC也不是AnnexB。因为上面可知AVCC用1<sub>4个字节表示NALU的长度，AnnexB用3</sub>4字节的起始码，而extradata是有一个6字节的header，里面有个字段叫<code>NALULengthSizeMinusOne</code>就是定义了AVCC使用多少个字节来表示NALU的长度。如果<code>NALULengthSizeMinusOne</code>等于0，那么AVCC用1字节表示NALU的长度。通常就是用4字节。</p>
<h6 id="extradata_1"><a class="toclink" href="../../streaming-h264-with-rtp/#extradata_1">extradata例子</a></h6>
<div class="highlight"><pre><span></span><code>(gdb) x /150bx fmt_ctx-&gt;streams[0]-&gt;codecpar-&gt;extradata
0x55555571d9c0: 0x01    0x64    0x00    0x28    0xff    0xe1    0x00    0x1e
0x55555571d9c8: 0x67    0x64    0x00    0x28    0xac    0xd1    0x00    0x78
0x55555571d9d0: 0x02    0x27    0xe5    0xc0    0x5a    0x80    0x80    0x80
0x55555571d9d8: 0xa0    0x00    0x00    0x03    0x00    0x20    0x00    0x00
0x55555571d9e0: 0x07    0x81    0xe3    0x06    0x22    0x40    0x01    0x00
0x55555571d9e8: 0x04    0x68    0xeb    0xef    0x2c    0x00    0x00    0x00
0x55555571d9f0: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571d9f8: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da00: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da08: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da10: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da18: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da20: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da28: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da30: 0x00    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da38: 0xc1    0x00    0x00    0x00    0x00    0x00    0x00    0x00
0x55555571da40: 0x9d    0xad    0x00    0x00    0x50    0x55    0x00    0x00
0x55555571da48: 0xfa    0x19    0xc4    0x92    0x40    0xa0    0xdc    0xba
0x55555571da50: 0x00    0x00    0x00    0x00    0x00    0x00
</code></pre></div>
<ul>
<li>第5字节0xff,二进制为:1111 1111, 后2位表示<code>NALULengthSizeMinusOne</code>=3，所以ffmpeg用4字节表示NALU的大小（AVCC格式）。</li>
<li>第6字节0xe1,二进制为:1110 0001，后5位表示SPS的个数=1,所以只有一个SPS。</li>
<li>第7，8字节表示SPS的长度，0x00，0x1e，二进制为:0000 0000, 0001 1110，所以SPS长度为30。</li>
<li>跳过30个字节，0x01，二进制为:0000 0001, 表示有1个PPS。</li>
<li>后面的2个字节，0x00,0x04,二进制为:0000,0004,表示PPS的长度为4个字节。</li>
</ul>
<h6 id="nalu_2"><a class="toclink" href="../../streaming-h264-with-rtp/#nalu_2">NALU头的解析</a></h6>
<p>NALU头是1字节，第一位F bit, 后两位NRI bit, 后五位表示NALU的type。</p>
<p>SPS的头是0x67，而进制为: 01100111，所以type值正好是7。
PPS的头是0x68，而进制为: 01101000，所以type值正好是8。</p>
<p>对比wireshark解析结果可以确认上面的理解正确，可见extradata就是6个字节的header加多个AVCC格式的NALU。</p>
<h6 id="extradata_2"><a class="toclink" href="../../streaming-h264-with-rtp/#extradata_2">创建extradata</a></h6>
<p>rtp解码时，需要手动生成extradata。创建AVCC格式的extradata
<div class="highlight"><pre><span></span><code>write(0x1);  // version
write(sps[0].data[1]); // profile
write(sps[0].data[2]); // compatibility
write(sps[0].data[3]); // level
write(0xFC | 3); // reserved (6 bits), NULA length size - 1 (2 bits)
write(0xE0 | 1); // reserved (3 bits), num of SPS (5 bits)
write_word(sps[0].size); // 2 bytes for length of SPS
for(size_t i=0 ; i &lt; sps[0].size ; ++i)
  write(sps[0].data[i]); // data of SPS

write(&amp;b, pps.size());  // num of PPS
for(size_t i=0 ; i &lt; pps.size() ; ++i) {
  write_word(pps[i].size);  // 2 bytes for length of PPS
  for(size_t j=0 ; j &lt; pps[i].size ; ++j)
    write(pps[i].data[j]);  // data of PPS
}
</code></pre></div></p>
<p>创建annexB格式的extradata
<div class="highlight"><pre><span></span><code>write(0x00)
write(0x00)
write(0x00)
write(0x01)
for each byte b in SPS
  write(b)

for each PPS p in PPS_array
  write(0x00)
  write(0x00)
  write(0x00)
  write(0x01)
  for each byte b in p
    write(b)
</code></pre></div></p>
<h3 id="wireshark"><a class="toclink" href="../../streaming-h264-with-rtp/#wireshark">wireshark解析</a></h3>
<p>从wiresshark对比用bsf和不用bsf的抓包发现，SEI包的内容没有变化，是不是可以不需要转成annexb，直接将PPS/SPS直接拷贝到packet中发出去呢？</p>
<h3 id="_5"><a class="toclink" href="../../streaming-h264-with-rtp/#_5">参考</a></h3>
<p>https://membrane.stream/learn/h264/3
https://github.com/cisco/openh264/issues/2501#issuecomment-231340268
https://stackoverflow.com/questions/17667002/how-to-add-sps-pps-read-from-mp4-file-information-to-every-idr-frame
https://stackoverflow.com/questions/24884827/possible-locations-for-sequence-picture-parameter-sets-for-h-264-stream
https://aviadr1.blogspot.com/2010/05/h264-extradata-partially-explained-for.html</p>
    
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../2025/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2025">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                2025
              </div>
            </div>
          </a>
        
        
          
          <a href="../2023/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2023">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2023
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../../js/tex-mml-chtml.js"></script>
      
        <script src="../../../js/mermaid.min.js"></script>
      
    
  </body>
</html>